{% extends "base.html" %}

{% block title %}Retrain Model - Waskita{% endblock %}

{% block page_title %}
    Retrain Model
{% endblock page_title %}

{% block breadcrumb %}
    <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Home</a></li>
    <li class="breadcrumb-item active">Retrain Model</li>
{% endblock breadcrumb %}

{% block content %}
    <div class="row">
        <!-- Main Form -->
        <div class="col-12">
            <div class="card card-outline card-primary">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-sync-alt mr-1"></i> Form Training Ulang
                    </h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-tool" data-card-widget="collapse">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
                
                <div class="card-body">
                    
                    {% if results %}
                    <!-- Results Section -->
                    {% if temp_mode %}
                        <div class="alert alert-info">
                            <h5><i class="icon fas fa-info-circle"></i> Review Hasil Training</h5>
                            <p>Model baru telah dilatih. Silakan tinjau hasil di bawah ini sebelum menerapkan ke production.</p>
                        </div>
                    {% else %}
                        <div class="alert alert-success">
                            <h5><i class="icon fas fa-check"></i> Sukses!</h5>
                            Model klasifikasi telah berhasil diperbarui ke production.
                        </div>
                    {% endif %}
                    
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>Model</th>
                                    <th>Akurasi</th>
                                    <th>Precision</th>
                                    <th>Recall</th>
                                    <th>F1-Score</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for model_name, metrics in results.items() %}
                                <tr>
                                    <td>{{ model_name|replace('_', ' ')|title }}</td>
                                    <td>{{ "%.2f"|format(metrics.accuracy * 100) }}%</td>
                                    <td>{{ "%.2f"|format(metrics.precision * 100) }}%</td>
                                    <td>{{ "%.2f"|format(metrics.recall * 100) }}%</td>
                                    <td>{{ "%.2f"|format(metrics.f1 * 100) }}%</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-4 d-flex justify-content-between">
                        <a href="{{ url_for('admin_retrain_model') }}" class="btn btn-default">
                            <i class="fas fa-arrow-left mr-1"></i> Batal / Ulangi
                        </a>
                        
                        {% if temp_mode %}
                        <form action="{{ url_for('admin_retrain_model') }}" method="post" class="d-inline">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="action" value="confirm_replace">
                            <button type="submit" class="btn btn-success" onclick="return confirm('Apakah Anda yakin ingin mengganti model production dengan model baru ini?');">
                                <i class="fas fa-save mr-1"></i> Simpan & Terapkan Model
                            </button>
                        </form>
                        {% endif %}
                    </div>

                    {% elif mapping_mode %}
                    <div class="alert alert-success">
                        <i class="icon fas fa-check"></i> File berhasil diupload: <strong>{{ filename }}</strong>. Kolom terdeteksi: <span class="badge badge-primary">{{ headers|length }}</span>
                    </div>
                    <div class="alert alert-info">
                        <i class="icon fas fa-info"></i> Silakan pilih kolom dari file CSV yang sesuai.
                    </div>

                    <form action="{{ url_for('admin_retrain_model') }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="action" value="train">
                        <input type="hidden" name="filename" value="{{ filename }}">
                        
                        <div class="form-group row">
                            <label for="col_text" class="col-sm-3 col-form-label">Kolom Teks (Kalimat)</label>
                            <div class="col-sm-9">
                                <select class="form-control" name="col_text" required>
                                    <option value="">-- Pilih Kolom --</option>
                                    {% for header in headers %}
                                    <option value="{{ header }}">{{ header }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group row">
                            <label for="col_label" class="col-sm-3 col-form-label">Kolom Label (Kelas)</label>
                            <div class="col-sm-9">
                                <select class="form-control" name="col_label" required>
                                    <option value="">-- Pilih Kolom --</option>
                                    {% for header in headers %}
                                    <option value="{{ header }}">{{ header }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="form-group mt-4">
                            <button type="submit" class="btn btn-primary float-right" id="btnTrainMap">
                                <i class="fas fa-play mr-1"></i> Mulai Training
                            </button>
                            <a href="{{ url_for('admin_retrain_model') }}" class="btn btn-default">Batal</a>
                        </div>
                    </form>

                    {% else %}
                    <!-- Upload Form Section -->
                    <form id="retrainForm" action="{{ url_for('admin_retrain_model') }}" method="post" enctype="multipart/form-data">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        
                        <div class="alert alert-light border">
                            <h5><i class="icon fas fa-info-circle"></i> Info</h5>
                            <p class="mb-0">
                                Upload file CSV dataset baru untuk melatih ulang model. 
                                Model baru akan disimpan sementara untuk direview sebelum diterapkan.
                            </p>
                        </div>

                        <div class="form-group row mt-4">
                            <label for="datasetFile" class="col-sm-3 col-form-label">File Dataset (CSV)</label>
                            <div class="col-sm-9">
                                <div class="input-group">
                                    <div class="custom-file">
                                        <input type="file" class="custom-file-input" id="datasetFile" name="file" accept=".csv" required>
                                        <label class="custom-file-label" for="datasetFile">Pilih file...</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4 d-flex justify-content-end">
                            <button type="submit" class="btn btn-primary" id="btnUpload">
                                <i class="fas fa-upload mr-1"></i> Upload & Lanjut
                            </button>
                        </div>
                        <div class="border-top mt-3 mb-3"></div>
                    </form>
                    {% if last_results %}
                    <div class="mt-3">
                        <h6 class="mb-2 text-muted"><i class="fas fa-history mr-1"></i> Riwayat Pelatihan Terakhir</h6>
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped table-hover">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Model</th>
                                        <th>Tanggal Training</th>
                                        <th>Akurasi</th>
                                        <th>Precision</th>
                                        <th>Recall</th>
                                        <th>F1-Score</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for model_name, metrics in last_results.items() %}
                                    <tr>
                                        <td>{{ model_name|replace('_', ' ')|title }}</td>
                                        <td>{{ metrics.last_trained if metrics.last_trained else '-' }}</td>
                                        <td>{{ "%.2f"|format(metrics.accuracy * 100) }}%</td>
                                        <td>{{ "%.2f"|format(metrics.precision * 100) }}%</td>
                                        <td>{{ "%.2f"|format(metrics.recall * 100) }}%</td>
                                        <td>{{ "%.2f"|format(metrics.f1 * 100) }}%</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}
                    {% endif %}
                    
                </div>
                
                <!-- Loading Overlay -->
                <div class="overlay dark" id="loadingOverlay" style="display: none;">
                    <div class="text-center w-75">
                        <i class="fas fa-3x fa-sync-alt fa-spin mb-3"></i>
                        <h5 class="text-bold" id="loadingText">Sedang Memproses...</h5>
                        <p id="loadingSubtext" class="mb-2">Mohon tunggu, proses ini mungkin memakan waktu.</p>
                        
                        <!-- Progress Bar -->
                        <div class="progress mt-3" style="height: 25px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                 role="progressbar" 
                                 style="width: 0%" 
                                 id="dynamicProgressBar"
                                 aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                0%
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}

{% block scripts %}
<script>
        $(document).ready(function () {
        if (typeof bsCustomFileInput !== 'undefined' && bsCustomFileInput && typeof bsCustomFileInput.init === 'function') {
            bsCustomFileInput.init();
        }

        // Update file label immediately when file selected
        $('#datasetFile').on('change', function() {
            var fileName = $(this).val().split('\\').pop();
            $(this).next('.custom-file-label').addClass("selected").html(fileName);
        });

        // Show loading overlay on form submit (Mapping or Upload)
        $('form').on('submit', function(e) {
            // Check validity if standard validation is used
            if(this.checkValidity()) {
                var formId = $(this).attr('id');
                var loadingText = "Sedang Memproses...";
                var loadingSubtext = "Mohon tunggu...";
                var startProgress = 0;
                
                if(formId === 'retrainForm') {
                    // Upload phase
                    loadingText = "Mengupload Dataset...";
                    loadingSubtext = "Sedang membaca dan memvalidasi file CSV.";
                    startProgress = 10;
                } else if($(this).find('input[name="action"]').val() === 'train') {
                    // Training phase
                    loadingText = "Melatih Model...";
                    loadingSubtext = "Preprocessing teks, vektorisasi, dan melatih 6 model klasifikasi.";
                    startProgress = 5;
                } else if($(this).find('input[name="action"]').val() === 'confirm_replace') {
                    // Confirm phase
                    loadingText = "Menerapkan Model...";
                    loadingSubtext = "Menyimpan model ke production dan memuat ulang sistem.";
                    startProgress = 50;
                }

                $('#loadingText').text(loadingText);
                $('#loadingSubtext').text(loadingSubtext);
                $('#loadingOverlay').css('display', 'flex').css('flex-direction', 'column').css('justify-content', 'center').css('align-items', 'center');
                
                // Simulate progress
                var progressBar = $('#dynamicProgressBar');
                var currentProgress = startProgress;
                progressBar.css('width', currentProgress + '%').text(currentProgress + '%');
                
                // Disable buttons to prevent double submit
                $(this).find('button[type="submit"]').prop('disabled', true);

                // Simulate progress bar movement
                var interval = setInterval(function() {
                    currentProgress += Math.floor(Math.random() * 5) + 1;
                    if(currentProgress > 90) {
                        currentProgress = 90; // Hold at 90 until complete
                        clearInterval(interval);
                    }
                    progressBar.css('width', currentProgress + '%').text(currentProgress + '%');
                }, 500);
            }
        });

        {% if mapping_mode and filename %}
        try {
            if (typeof swalSuccess === 'function') {
                swalSuccess('Upload Berhasil', 'File {{ filename }} berhasil diupload. Ditemukan {{ headers|length }} kolom.');
            } else if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'success',
                    title: 'Upload Berhasil',
                    text: 'File {{ filename }} berhasil diupload. Ditemukan {{ headers|length }} kolom.'
                });
            }
        } catch (e) {}
        {% endif %}
    });
</script>
{% endblock %}
