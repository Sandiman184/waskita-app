{% extends "base.html" %}

{% block title %}Klasifikasi Batch - Waskita{% endblock title %}

{% block page_title %}Klasifikasi Batch{% endblock page_title %}

{% block breadcrumb %}
<li class="breadcrumb-item">
    <a href="{{ url_for('dashboard') }}">Home</a>
</li>
<li class="breadcrumb-item">
    <a href="{{ url_for('classification') }}">Klasifikasi</a>
</li>
<li class="breadcrumb-item active">Batch</li>
{% endblock breadcrumb %}

{% block stylesheets %}
    <style>
        .progress-section {
            margin-top: 20px;
        }
        
        .card.border-left-success {
            border-left: 4px solid #28a745;
        }
        
        .btn-success.btn-lg {
            padding: 12px 30px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: 180px;
        }
        
        .empty-state {
            padding: 40px 20px;
        }
        
        .empty-state i {
            opacity: 0.5;
        }
        
        .empty-state h5 {
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .empty-state p {
            font-size: 14px;
            line-height: 1.5;
        }
    </style>
{% endblock stylesheets %}

{% block content %}
<section class="content">
    <div class="container-fluid">
        <!-- Header with Dataset Info and Back Button -->
        <div class="row mb-3 align-items-center">
            <div class="col-md-8">
                <div class="d-flex align-items-center">
                    <i class="fas fa-layer-group fa-lg text-dark mr-3"></i>
                    <h5 class="mb-0 text-dark">Dataset Terpilih untuk Klasifikasi Batch</h5>
                </div>
            </div>
            <div class="col-md-4 text-right">
                <a href="{{ url_for('classification') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left mr-2"></i>Kembali ke Klasifikasi
                </a>
            </div>
        </div>

        <!-- Data Preview -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div id="dataLoading" class="text-center">
                            <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                            <p class="mt-2">Memuat data...</p>
                        </div>
                        
                        <div id="dataPreview" style="display: none;">
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover" id="previewTable">
                                    <thead class="thead-light">
                                        <tr>
                                            <th width="20%">Sumber Data</th>
                                            <th width="20%">Username</th>
                                            <th width="45%">Konten</th>
                                            <th width="15%">URL</th>
                                        </tr>
                                    </thead>
                                    <tbody id="previewTableBody">
                                        <!-- Data akan diisi melalui JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div id="noDataMessage" style="display: none;" class="text-center text-muted">
                            <i class="fas fa-exclamation-triangle fa-2x"></i>
                            <p class="mt-2">Tidak ada data bersih yang tersedia untuk klasifikasi</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Classification Controls -->
        <div class="row">
            <div class="col-12">
                <div class="card border-left-success shadow">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <!-- Informasi klasifikasi dihapus -->
                            </div>
                            <div class="col-md-6 text-right">
                                <button id="startClassification" class="btn btn-success btn-lg" disabled>
                                    <i class="fas fa-play mr-2"></i>Mulai Klasifikasi
                                </button>
                            </div>
                        </div>
                        
                        <div class="d-none" id="progressSection">
                            <hr>
                            <h6><i class="fas fa-tasks mr-2"></i>Progress Klasifikasi</h6>
                            <div class="progress mb-2">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%" id="progressBar">
                                    0%
                                </div>
                            </div>
                            <div id="progressText" class="text-muted">
                                Memulai klasifikasi...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock content %}

{% block scripts %}
<script>
let currentDatasetId = null;
let previewData = [];

$(document).ready(function() {
    // Get dataset_id from URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    currentDatasetId = urlParams.get('dataset_id');
    
    // Initialize progress section as hidden
    $('#progressSection').addClass('d-none');
    $('#progressBar').css('width', '0%').text('0%');
    $('#progressText').text('Memulai klasifikasi...');
    
    if (currentDatasetId) {
        loadPreviewData();
    } else {
        window.location.href = '/classification';
    }
    
    $('#startClassification').click(function() {
        startBatchClassification();
    });
});

function loadPreviewData() {
    // Show loading state
    $('#dataLoading').show();
    $('#noDataMessage').hide();
    $('#dataPreview').hide();
    $('#startClassification').prop('disabled', true);
    
    $.ajax({
        url: `/api/dataset/${currentDatasetId}/clean-data`,
        method: 'GET',
        success: function(response) {
            $('#dataLoading').hide();
            
            if (response.success && response.data && response.data.length > 0) {
                previewData = response.data.slice(0, 10);
                displayPreviewData();
                $('#dataPreview').show();
                $('#startClassification').prop('disabled', false);
            } else {
                $('#noDataMessage').show().html(`
                    <div class="text-center py-4">
                        <i class="fas fa-info-circle fa-3x text-info mb-3"></i>
                        <h5>Tidak Ada Data untuk Diklasifikasi</h5>
                        <p class="text-muted">Dataset ini belum memiliki data yang sudah dibersihkan atau semua data sudah diklasifikasi.</p>
                        <div class="mt-3">
                            <a href="/dataset/${currentDatasetId}/details" class="btn btn-primary">
                                <i class="fas fa-eye mr-2"></i>Lihat Detail Dataset
                            </a>
                            <a href="/classification" class="btn btn-secondary ml-2">
                                <i class="fas fa-arrow-left mr-2"></i>Kembali
                            </a>
                        </div>
                    </div>
                `);
                $('#startClassification').prop('disabled', true);
            }
        },
        error: function(xhr, status, error) {
            $('#dataLoading').hide();
            
            let errorMessage = 'Terjadi kesalahan saat memuat data';
            let errorIcon = 'error';
            let actionButtons = '';
            
            // Handle different error types
            if (xhr.status === 404) {
                errorMessage = 'Dataset tidak ditemukan';
                errorIcon = 'warning';
                actionButtons = `
                    <div class="mt-3">
                        <a href="/classification" class="btn btn-primary">
                            <i class="fas fa-arrow-left mr-2"></i>Pilih Dataset Lain
                        </a>
                    </div>
                `;
            } else if (xhr.status === 403) {
                errorMessage = 'Anda tidak memiliki akses ke dataset ini';
                errorIcon = 'warning';
                actionButtons = `
                    <div class="mt-3">
                        <a href="/classification" class="btn btn-primary">
                            <i class="fas fa-arrow-left mr-2"></i>Kembali ke Daftar Dataset
                        </a>
                    </div>
                `;
            } else if (xhr.status === 500) {
                errorMessage = 'Terjadi kesalahan server. Silakan coba lagi nanti.';
                actionButtons = `
                    <div class="mt-3">
                        <button onclick="loadPreviewData()" class="btn btn-primary">
                            <i class="fas fa-redo mr-2"></i>Coba Lagi
                        </button>
                        <a href="/classification" class="btn btn-secondary ml-2">
                            <i class="fas fa-arrow-left mr-2"></i>Kembali
                        </a>
                    </div>
                `;
            } else {
                // Try to get error message from response
                try {
                    const response = JSON.parse(xhr.responseText);
                    if (response.message) {
                        errorMessage = response.message;
                    }
                } catch (e) {
                    errorMessage = `Error ${xhr.status}: ${error}`;
                }
                
                actionButtons = `
                    <div class="mt-3">
                        <button onclick="loadPreviewData()" class="btn btn-primary">
                            <i class="fas fa-redo mr-2"></i>Coba Lagi
                        </button>
                        <a href="/classification" class="btn btn-secondary ml-2">
                            <i class="fas fa-arrow-left mr-2"></i>Kembali
                        </a>
                    </div>
                `;
            }
            
            $('#noDataMessage').show().html(`
                <div class="text-center py-4">
                    <i class="fas fa-exclamation-triangle fa-3x text-${errorIcon === 'error' ? 'danger' : 'warning'} mb-3"></i>
                    <h5>Error Memuat Data</h5>
                    <p class="text-muted">${errorMessage}</p>
                    ${actionButtons}
                </div>
            `);
            $('#startClassification').prop('disabled', true);
            
            // Show error notification
            Swal.fire({
                title: 'Error',
                text: errorMessage,
                icon: errorIcon,
                confirmButtonText: 'OK'
            });
        }
    });
}

function displayPreviewData() {
    const tbody = $('#previewTableBody');
    tbody.empty();
    
    if (!previewData || previewData.length === 0) {
        // Show empty state message
        const emptyRow = `
            <tr>
                <td colspan="4" class="text-center py-5">
                    <div class="empty-state">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Tidak Ada Data</h5>
                        <p class="text-muted mb-0">
                            Belum ada data yang tersedia untuk ditampilkan.<br>
                            Pastikan data sudah di-upload atau di-scrape dan telah dibersihkan.
                        </p>
                    </div>
                </td>
            </tr>
        `;
        tbody.append(emptyRow);
        $('#startClassification').prop('disabled', true);
        return;
    }
    
    previewData.forEach(function(item, index) {
        const row = `
            <tr>
                <td>
                    <span class="badge badge-${item.data_type === 'upload' ? 'primary' : 'info'}">
                        ${item.data_type === 'upload' ? 'Upload' : 'Scraper'}
                    </span>
                </td>
                <td>${item.username || '-'}</td>
                <td>
                    <div style="max-height: 100px; overflow-y: auto;">
                        ${item.content || item.full_content || '-'}
                    </div>
                </td>
                <td>
                    ${item.url ? `<a href="${item.url}" target="_blank" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-external-link-alt"></i>
                    </a>` : '-'}
                </td>
            </tr>
        `;
        tbody.append(row);
    });
    
    // Enable classification button if data is available
    $('#startClassification').prop('disabled', false);
}

function startBatchClassification() {
    // Show loading state
    Swal.fire({
        title: 'Memuat Data...',
        text: 'Sedang memuat data untuk klasifikasi',
        icon: 'info',
        allowOutsideClick: false,
        showConfirmButton: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });

    $.ajax({
        url: `/api/dataset/${currentDatasetId}/clean-data`,
        method: 'GET',
        success: function(response) {
            Swal.close(); // Close loading dialog
            
            if (response.success === false) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error Server',
                    text: 'Terjadi kesalahan pada server saat memuat data',
                    confirmButtonText: 'OK'
                });
                return;
            }
            
            if (response.data && response.data.length > 0) {
                const allData = response.data.map(function(item) {
                    return {
                        data_id: item.id,
                        data_type: item.data_type
                    };
                });
                
                Swal.fire({
                    title: 'Konfirmasi Klasifikasi Batch',
                    text: `Anda akan mengklasifikasi semua ${allData.length} data dalam dataset ini. Lanjutkan?`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#28a745',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Ya, Klasifikasi Semua',
                    cancelButtonText: 'Batal'
                }).then((result) => {
                    if (result.isConfirmed) {
                        processAllData(allData);
                    }
                });
            } else {
                Swal.fire({
                    icon: 'warning',
                    title: 'Data Tidak Tersedia',
                    html: `
                        <p>Tidak ada data yang tersedia untuk diklasifikasi.</p>
                        <p><strong>Kemungkinan penyebab:</strong></p>
                        <ul style="text-align: left; margin: 10px 0;">
                            <li>Data belum di-upload atau di-scrape</li>
                            <li>Data belum dibersihkan (cleaning)</li>
                            <li>Dataset kosong</li>
                        </ul>
                        <p>Silakan periksa data Anda terlebih dahulu.</p>
                    `,
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#007bff'
                });
            }
        },
        error: function(xhr, status, error) {
            Swal.close(); // Close loading dialog
            
            let errorMessage = 'Gagal memuat data untuk klasifikasi';
            let errorTitle = 'Error';
            
            if (xhr.status === 404) {
                errorTitle = 'Dataset Tidak Ditemukan';
                errorMessage = 'Dataset yang diminta tidak ditemukan. Pastikan dataset masih tersedia.';
            } else if (xhr.status === 403) {
                errorTitle = 'Akses Ditolak';
                errorMessage = 'Anda tidak memiliki akses untuk melihat dataset ini.';
            } else if (xhr.status === 500) {
                errorTitle = 'Error Server';
                errorMessage = 'Terjadi kesalahan pada server. Silakan coba lagi nanti.';
            } else if (xhr.status === 0) {
                errorTitle = 'Koneksi Terputus';
                errorMessage = 'Tidak dapat terhubung ke server. Periksa koneksi internet Anda.';
            }
            
            Swal.fire({
                icon: 'error',
                title: errorTitle,
                text: errorMessage,
                confirmButtonText: 'OK',
                confirmButtonColor: '#dc3545'
            });
        }
    });
}

function processAllData(allData) {
    $('#progressSection').removeClass('d-none');
    $('#startClassification').prop('disabled', true).html(`
        <i class="fas fa-spinner fa-spin mr-2"></i>Memproses...
    `);
    
    const csrfToken = $('meta[name=csrf-token]').attr('content');
    
    // Reset previous classification results before starting new classification
    $.ajax({
        url: '/api/classification/reset-latest',
        method: 'POST',
        contentType: 'application/json',
        headers: {
            'X-CSRFToken': csrfToken
        },
        success: function(resetResponse) {
            if (resetResponse.success) {
                console.log('Reset previous results:', resetResponse.message);
                
                // Start classification with progress tracking
                startClassificationProcess();
            } else {
                throw new Error(resetResponse.message);
            }
        },
        error: function(xhr, status, error) {
            console.error('Error resetting previous results:', error);
            // Continue with classification even if reset fails
            startClassificationProcess();
        }
    });
    
    function startClassificationProcess() {
        // Start classification with progress tracking
        $.ajax({
            url: '/api/classification/start',
            method: 'POST',
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': csrfToken
            },
            data: JSON.stringify({
                dataset_id: currentDatasetId
            }),
        success: function(response) {
            if (response.success) {
                // Start polling for progress updates
                startProgressPolling(currentDatasetId);
            } else {
                throw new Error(response.message);
            }
        },
        error: function(xhr, status, error) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: `Terjadi kesalahan: ${error}`
            });
            $('#startClassification').prop('disabled', false).html(`
                <i class="fas fa-play mr-2"></i>Mulai Klasifikasi
            `);
        }
    });
    }
}

function startProgressPolling(datasetId) {
    let progressInterval = setInterval(function() {
        $.ajax({
            url: `/api/classification/progress/${datasetId}`,
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    const progress = response.progress;
                    
                    // Update progress bar
                    $('#progressBar').css('width', `${progress.percentage}%`).text(`${progress.percentage}%`);
                    
                    // Update progress text with real-time statistics
                    $('#progressText').html(`
                        <div class="row">
                            <div class="col-4">
                                <small class="text-success">
                                    <i class="fas fa-check-circle"></i> Diproses: ${progress.processed}/${progress.total}
                                </small>
                            </div>
                            <div class="col-4">
                                <small class="text-danger">
                                    <i class="fas fa-radiation"></i> Radikal: ${progress.radikal_count}
                                </small>
                            </div>
                            <div class="col-4">
                                <small class="text-primary">
                                    <i class="fas fa-shield-alt"></i> Non-Radikal: ${progress.non_radikal_count}
                                </small>
                            </div>
                        </div>
                        <div class="row mt-1">
                            <div class="col-12">
                                <small class="text-warning">
                                    <i class="fas fa-exclamation-triangle"></i> Error: ${progress.error_count}
                                </small>
                            </div>
                        </div>
                    `);
                    
                    // Check if completed
                    if (progress.status === 'completed') {
                        clearInterval(progressInterval);
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'Klasifikasi Selesai',
                            html: `
                                <div class="text-left">
                                    <p><strong>Hasil Klasifikasi:</strong></p>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="text-success">âœ“ Diproses: ${progress.processed} data</span>
                                        <span class="text-danger">â˜¢ Radikal: ${progress.radikal_count}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="text-primary">ðŸ›¡ Non-Radikal: ${progress.non_radikal_count}</span>
                                        <span class="text-warning">âš  Error: ${progress.error_count}</span>
                                    </div>
                                </div>
                            `,
                            confirmButtonText: 'Lihat Hasil'
                        }).then(() => {
                            // Show latest classification results
                            showLatestClassificationResults();
                            window.location.href = '/classification/results';
                        });
                    }
                    
                    // Check if error
                    if (progress.status === 'error') {
                        clearInterval(progressInterval);
                        
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Terjadi kesalahan selama proses klasifikasi'
                        });
                        
                        $('#startClassification').prop('disabled', false).html(`
                            <i class="fas fa-play mr-2"></i>Mulai Klasifikasi
                        `);
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('Error fetching progress:', error);
            }
        });
    }, 1000); // Poll every second
}

function showLatestClassificationResults() {
    // Fetch latest classification results
    $.ajax({
        url: '/api/classification/latest-results',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                const results = response.results;
                
                // Calculate model-specific totals
                const model1Total = results.model_stats.model1.radikal + results.model_stats.model1.non_radikal;
                const model2Total = results.model_stats.model2.radikal + results.model_stats.model2.non_radikal;
                const model3Total = results.model_stats.model3.radikal + results.model_stats.model3.non_radikal;
                
                // Show results in a modal
                Swal.fire({
                    title: 'Hasil Klasifikasi Terbaru',
                    html: `
                        <div class="text-left">
                            <div class="mb-3">
                                <h6 class="text-primary">Total Hasil Klasifikasi</h6>
                                <div class="d-flex justify-content-between">
                                    <span>${results.total_classifications} konten Ã— 3 model</span>
                                    <strong>${results.total_classifications * 3} hasil</strong>
                                </div>
                                <small class="text-muted">Semua prediksi dari ketiga model</small>
                            </div>
                            
                            <div class="mb-3">
                                <h6 class="text-danger">Total Radikal</h6>
                                <div class="d-flex justify-content-between">
                                    <span>${results.total_radikal} prediksi</span>
                                    <strong>${results.radikal_percentage}% dari total</strong>
                                </div>
                                <small class="text-muted">Semua prediksi radikal dari 3 model</small>
                            </div>
                            
                            <div class="mb-3">
                                <h6 class="text-success">Total Non-Radikal</h6>
                                <div class="d-flex justify-content-between">
                                    <span>${results.total_non_radikal} prediksi</span>
                                    <strong>${results.non_radikal_percentage}% dari total</strong>
                                </div>
                                <small class="text-muted">Semua prediksi non-radikal dari 3 model</small>
                            </div>
                            
                            <div class="mb-3">
                                <h6 class="text-info">Hasil Per Model</h6>
                                <div class="row">
                                    <div class="col-4">
                                        <small>Model 1:</small><br>
                                        <span class="text-danger">${results.model_stats.model1.radikal} radikal</span><br>
                                        <span class="text-success">${results.model_stats.model1.non_radikal} non-radikal</span>
                                    </div>
                                    <div class="col-4">
                                        <small>Model 2:</small><br>
                                        <span class="text-danger">${results.model_stats.model2.radikal} radikal</span><br>
                                        <span class="text-success">${results.model_stats.model2.non_radikal} non-radikal</span>
                                    </div>
                                    <div class="col-4">
                                        <small>Model 3:</small><br>
                                        <span class="text-danger">${results.model_stats.model3.radikal} radikal</span><br>
                                        <span class="text-success">${results.model_stats.model3.non_radikal} non-radikal</span>
                                    </div>
                                </div>
                                <small class="text-muted">Total: ${results.total_classifications * 3} hasil klasifikasi</small>
                            </div>
                        </div>
                    `,
                    width: '600px',
                    confirmButtonText: 'Tutup',
                    showCloseButton: true
                });
            } else {
                console.error('Error fetching latest results:', response.message);
            }
        },
        error: function(xhr, status, error) {
            console.error('Error fetching latest classification results:', error);
        }
    });
}
</script>
{% endblock scripts %}