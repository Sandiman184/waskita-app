<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description"
              content="First Login OTP Verification - Waskita">
        <meta name="csrf-token" content="{{ csrf_token() }}">
        
        <!-- Favicon -->
        <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='images/favicon.svg') }}">
        <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
        <link rel="shortcut icon" type="image/x-icon" href="{{ url_for('static', filename='images/favicon.ico') }}">

        <title>OTP Verification - Waskita</title>
        <!-- Google Font: Source Sans Pro -->
        <link rel="stylesheet"
              href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
        <!-- Font Awesome -->
        <link rel="stylesheet"
              href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <!-- AdminLTE CSS -->
        <link rel="stylesheet"
              href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
        <!-- SweetAlert2 CSS -->
        <link rel="stylesheet"
              href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
        <!-- Auth Custom CSS -->
        <link rel="stylesheet" href="{{ url_for('static', filename='css/variables.css') }}">
        <link rel="stylesheet" href="{{ url_for('static', filename='css/auth.css') }}">
    </head>
    <body class="hold-transition login-page dark-mode">
        <div class="login-box">
            <div class="card card-outline card-primary">
                <header class="card-header brand-header" role="banner">
                    <div class="brand-logo">
                        <img src="{{ url_for('static', filename='images/logo.webp') }}" alt="Waskita Logo" />
                    </div>
                    <h1 class="brand-text">WASKITA</h1>
                    <p class="brand-subtitle mb-0">Content Classification System</p>
                </header>
                <main class="card-body" role="main">
                    <div class="text-center mb-3">
                        <i class="fas fa-shield-alt fa-3x text-primary mb-2"></i>
                        <h5 class="login-box-msg pb-0">Security Verification</h5>
                        <p class="text-muted small">Enter the 6-digit code sent to your email</p>
                    </div>

                    <!-- Flash messages -->
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            <div role="alert" aria-live="polite" aria-atomic="true">
                                {% for category, message in messages %}
                                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show"
                                         role="alert">
                                        {{ message }}
                                        <button type="button" class="close" data-dismiss="alert" aria-label="Close message">
                                            <span aria-hidden="true">Ã—</span>
                                        </button>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    {% endwith %}

                    <form method="post" action="{{ url_for('otp.verify_first_login_otp') }}" id="otpForm">
                        {{ form.hidden_tag() }}
                        <div class="form-group">
                            <label for="otp" class="sr-only">OTP Code</label>
                            <div class="input-group mb-3">
                                <div class="input-group-prepend">
                                    <span class="input-group-text">
                                        <i class="fas fa-key"></i>
                                    </span>
                                </div>
                                <input type="text"
                                       id="otp"
                                       name="otp"
                                       class="form-control text-center"
                                       placeholder="Enter 6-digit Code"
                                       maxlength="6"
                                       pattern="[0-9]{6}"
                                       autocomplete="one-time-code"
                                       required
                                       style="letter-spacing: 5px; font-weight: bold; font-size: 1.2rem;">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary btn-block">
                                    <i class="fas fa-check-circle mr-1"></i> Verify & Continue
                                </button>
                            </div>
                        </div>
                    </form>

                    <div class="mt-4 text-center">
                        <p class="mb-1 text-muted small">Didn't receive the code?</p>
                        <button type="button" 
                                id="resendBtn" 
                                class="btn btn-tool text-primary p-0" 
                                onclick="resendOTP()">
                            <i class="fas fa-redo mr-1"></i> Resend OTP
                        </button>
                        <div id="timer" class="text-muted small mt-2" style="display: none;">
                            Can resend in <span id="countdown">60</span>s
                        </div>
                    </div>
                </main>
                <div class="card-footer text-center">
                    <small class="text-muted">
                        <i class="fas fa-lock mr-1"></i>
                        Secure verification powered by Waskita
                    </small>
                </div>
            </div>
        </div>

        <!-- jQuery -->
        <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
        <!-- Bootstrap 4 -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
        <!-- AdminLTE App -->
        <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
        <!-- SweetAlert2 -->
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

        <script>
        document.addEventListener('DOMContentLoaded', function() {
            const otpInput = document.getElementById('otp');
            if (otpInput) {
                otpInput.focus();
                
                // Allow only numbers
                otpInput.addEventListener('input', function(e) {
                    this.value = this.value.replace(/[^0-9]/g, '');
                });
            }
            
            // Start countdown if we suspect user just landed (simple simulation, 
            // in real app you might want to check server time)
            startCountdown();
        });

        let countdown = 60;
        let countdownInterval;

        function startCountdown() {
            const resendBtn = document.getElementById('resendBtn');
            const timer = document.getElementById('timer');
            
            resendBtn.disabled = true;
            resendBtn.style.opacity = '0.5';
            resendBtn.style.cursor = 'not-allowed';
            timer.style.display = 'block';
            
            countdownInterval = setInterval(function() {
                countdown--;
                document.getElementById('countdown').textContent = countdown;
                
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    resendBtn.disabled = false;
                    resendBtn.style.opacity = '1';
                    resendBtn.style.cursor = 'pointer';
                    timer.style.display = 'none';
                    countdown = 60;
                }
            }, 1000);
        }

        function resendOTP() {
            const resendBtn = document.getElementById('resendBtn');
            
            // Show loading
            resendBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Sending...';
            resendBtn.disabled = true;

            fetch('{{ url_for("otp.resend_first_login_otp") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': $('meta[name="csrf-token"]').attr('content')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'OTP Resent',
                        text: 'A new verification code has been sent to your email.',
                        timer: 3000,
                        showConfirmButton: false
                    });
                    
                    // Restart countdown
                    if (countdownInterval) clearInterval(countdownInterval);
                    countdown = 60;
                    startCountdown();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Failed',
                        text: data.message || 'Failed to resend OTP',
                    });
                    resendBtn.disabled = false;
                }
                resendBtn.innerHTML = '<i class="fas fa-redo mr-1"></i> Resend OTP';
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'An unexpected error occurred',
                });
                resendBtn.disabled = false;
                resendBtn.innerHTML = '<i class="fas fa-redo mr-1"></i> Resend OTP';
            });
        }
        </script>
    </body>
</html>