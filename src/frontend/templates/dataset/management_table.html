{% extends "base.html" %}

{% block title %}Dataset Management - Table View{% endblock title %}

{% block page_title %}Dataset Management{% endblock page_title %}

{% block breadcrumb %}
    <li class="breadcrumb-item">
        <a href="{{ url_for('main.dashboard') }}">Home</a>
    </li>
    <li class="breadcrumb-item active">Dataset Management</li>
{% endblock breadcrumb %}

{% block extra_css %}
<style>
/* Empty State Styling */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px;
    margin: 20px;
    border: 2px dashed #dee2e6;
}

.empty-state-icon {
    font-size: 4rem;
    color: #6c757d;
    margin-bottom: 20px;
    opacity: 0.7;
}

.empty-state-text {
    color: #495057;
    font-weight: 600;
    margin-bottom: 10px;
    font-size: 1.25rem;
}

.empty-state p {
    color: #6c757d;
    font-size: 0.95rem;
    margin-bottom: 30px;
}

.btn-action {
    padding: 10px 20px;
    font-weight: 500;
    border-radius: 8px;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-action:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.btn-action i {
    font-size: 0.9rem;
}

/* Peningkatan Responsivitas Tabel */
.table-responsive {
    max-height: 70vh;
    overflow-y: auto;
}

.table thead th {
    position: sticky;
    top: 0;
    z-index: 1;
    box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.05);
}

.table tbody tr {
    transition: background-color 0.2s ease;
}

.table tbody tr:hover {
    background-color: #f8f9fa !important;
}

body.dark-mode .table tbody tr:hover {
    background-color: rgba(255, 255, 255, 0.075) !important;
}

/* UI Polish: spacing, typography, accessibility */
:root {
  --table-cell-x: 16px;
  --table-cell-y: 12px;
  --text-primary: #344767;
  --text-muted: #8392ab;
  --accent-color: #1976d2;
}

.table td, .table th { 
    padding: var(--table-cell-y) var(--table-cell-x) !important;
    vertical-align: middle !important;
}

/* Header Styling */
.table thead th {
    font-size: 0.75rem !important;
    font-weight: 700 !important;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-muted);
    background-color: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
}

/* Left-aligned column headers for readability */
.table thead th.dataset-column,
.table thead th.content-column,
.table thead th.username-column { text-align: left !important; }

/* Left-aligned and proportional cell text */
td.dataset-cell,
td.content-column,
td.username-column { text-align: left !important; }

/* Typography */
td.dataset-cell h6 {
    font-size: 0.95rem !important;
    font-weight: 600;
    color: var(--text-primary);
    line-height: 1.4;
    margin-bottom: 4px !important;
}

td.dataset-cell p {
    color: var(--text-muted);
    font-size: 0.75rem !important;
}

.username-text {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-primary);
}

.content-text {
    font-size: 0.85rem;
    color: var(--text-primary);
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* Column Widths */
.dataset-column { width: 25%; min-width: 200px; }
.content-column { width: 30%; min-width: 250px; }
.username-column { width: 15%; min-width: 120px; }
.url-column { width: 5%; min-width: 60px; }
.stats-column { width: 15%; min-width: 150px; }
.status-column { width: 10%; min-width: 100px; }
.date-column { width: 12%; min-width: 140px; }
.action-column { width: 10%; min-width: 140px; }

/* Header & Button Styling Enhancements */
.card-header {
    background: linear-gradient(to right, #ffffff, #f8f9fa);
    border-bottom: 1px solid rgba(0,0,0,0.05);
}

.card-header h6 {
    font-size: 1.25rem !important;
    font-weight: 700 !important;
    color: #344767;
    letter-spacing: -0.5px;
    margin-bottom: 0;
}

.header-action-btn {
    font-weight: 600 !important;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-size: 0.75rem !important;
    padding: 10px 20px !important;
    border-radius: 8px !important;
    box-shadow: 0 4px 6px rgba(50, 50, 93, 0.11), 0 1px 3px rgba(0, 0, 0, 0.08) !important;
    transition: all 0.2s ease !important;
}

.header-action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 7px 14px rgba(50, 50, 93, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08) !important;
}

/* Dark Mode Header */
body.dark-mode .card-header {
    background: linear-gradient(to right, #343a40, #2b3035);
    border-bottom-color: #454d55;
}

body.dark-mode .card-header h6 {
    color: #fff;
}

/* Stats Styling */
.stats-container {
    display: flex;
    justify-content: center;
    gap: 16px;
}

.stats-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
}

.stats-label {
    font-size: 0.7rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.stats-value {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-primary);
}

.stats-value i {
    font-size: 0.75rem;
    color: var(--text-muted);
}

/* Action Buttons */
.action-btn {
    width: 34px;
    height: 34px;
    padding: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    border: 1px solid #e9ecef;
    background: #fff;
    color: var(--text-muted);
    transition: all 0.2s ease;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

.action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 6px rgba(0,0,0,0.08);
    background-color: #fff;
    color: var(--accent-color);
    border-color: var(--accent-color);
}

.action-btn.text-danger:hover {
    color: #dc3545;
    border-color: #dc3545;
}

/* Status Badges */
.status-badge {
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.3px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    min-width: 90px;
    justify-content: center;
}

/* URL Icon */
.url-icon {
    width: 34px;
    height: 34px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    border: 1px solid #e9ecef;
    color: var(--text-muted);
    transition: all 0.2s ease;
}

.url-icon:hover {
    background-color: #f8f9fa;
    color: var(--accent-color);
    border-color: var(--accent-color);
}

/* Dark Mode */
body.dark-mode .table td,
body.dark-mode .table th {
    border-color: #2d3748;
}

body.dark-mode .table thead th {
    background-color: #1a202c;
    color: #a0aec0;
}

body.dark-mode td.dataset-cell h6,
body.dark-mode .username-text,
body.dark-mode .content-text,
body.dark-mode .stats-value {
    color: #fff;
}

body.dark-mode .action-btn,
body.dark-mode .url-icon {
    background-color: #2d3748;
    border-color: #4a5568;
    color: #a0aec0;
}

body.dark-mode .action-btn:hover,
body.dark-mode .url-icon:hover {
    background-color: #4a5568;
    color: #fff;
}
/* Button Consistency */
.btn-action {
    min-width: auto; /* Remove fixed width constraint */
    min-height: 32px; /* Reduce from 38px */
    padding: 6px 12px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 500;
    border-radius: 4px;
}

/* Bulk Action Buttons Consistency */
.btn-bulk-action {
    min-width: 80px !important;
    min-height: 32px !important;
    padding: 6px 12px !important;
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    font-size: 12px !important;
    font-weight: 500 !important;
    border-radius: 4px !important;
}
.btn-bulk-action i {
    margin-right: 4px !important;
}
/* Override Bootstrap btn-sm conflicts */
.btn-bulk-action.btn-sm {
    min-width: 80px !important;
    min-height: 28px !important;
    padding: 4px 8px !important;
    font-size: 11px !important;
}

/* Responsive for header actions & search toolbar */
.page-actions { flex-wrap: wrap; gap: 16px; justify-content: flex-end; }
.search-toolbar { flex-wrap: nowrap; gap: 8px; }
.search-toolbar .form-control { flex: 1 1 0; min-width: 0; width: auto; }
.search-toolbar .btn-search { flex: 0 0 auto; }

@media (max-width: 576px) {
  .card.mb-4 { margin-left: .5rem; margin-right: .5rem; }
  .card-header .d-flex { gap: 8px; }
  .page-actions { justify-content: center; }
  .page-actions .btn-action { flex: 1 1 calc(50% - 8px); min-width: 140px; }
  .page-actions .mr-2 { margin-right: 0 !important; }
  
  /* Mobile Sort & Pagination */
  .dropdown-sort,
  .dropdown-pagination {
    width: 100% !important;
    margin-top: 8px !important;
  }
}

/* Table Responsive Handling */
.table-responsive {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

/* Dark Mode Enhancements for Table and Pagination */
body.dark-mode .table {
    background-color: #343a40 !important;
    color: #f8f9fa !important;
}

body.dark-mode .table thead th {
    background-color: #454d55 !important;
    color: #fff !important;
    border-bottom-color: #56606a !important;
}

body.dark-mode .page-link {
    background-color: #343a40;
    border-color: #495057;
    color: #f8f9fa;
}

body.dark-mode .page-item.disabled .page-link {
    background-color: #2b3035;
    border-color: #495057;
    color: #6c757d;
}

body.dark-mode .page-item.active .page-link {
    background-color: #3f6791;
    border-color: #3f6791;
    color: #fff;
}

/* Font Consistency */
h6 { font-size: 1.1rem !important; font-weight: 600; }
.text-xs { font-size: 0.85rem !important; }
.text-sm { font-size: 0.9rem !important; }

/* Standardized Button Sizes */
.btn { 
    font-size: 12px !important; 
    padding: 6px 12px !important;
    border-radius: 4px !important;
}
.form-control { font-size: 0.9rem !important; }
</style>
</style>
{% endblock extra_css %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card mb-4 mx-2 mx-md-0">
                <div class="card-header pb-3">
                    <div class="d-flex justify-content-between align-items-center flex-column flex-sm-row gap-2">
                        <div>
                            <h6>Dataset Management</h6>
                        </div>
                        <div class="d-flex align-items-center gap-3 page-actions">
                            <a href="{{ url_for('dataset.upload_file') }}" class="btn btn-primary btn-action header-action-btn mr-2">
                                <i class="fas fa-upload mr-1"></i> Upload Data
                            </a>
                            <a href="{{ url_for('scraper.index') }}" class="btn btn-success btn-action header-action-btn">
                                <i class="fas fa-spider mr-1"></i> Scraper Data
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Search and Filter Section -->
                <div class="card-body px-2 px-md-4 px-lg-5 pt-3 pb-4">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <form method="get" class="d-flex search-toolbar">
                                <input type="text" name="search" class="form-control" placeholder="Search dataset..." value="{{ search }}">
                                <button type="submit" class="btn btn-outline-primary ml-2 btn-search">
                                    <i class="fas fa-search"></i>
                                </button>
                            </form>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex justify-content-end flex-wrap gap-2">
                                <div class="dropdown mr-2">
                    <button class="btn btn-outline-secondary dropdown-toggle dropdown-sort" type="button" data-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-sort"></i> Sort
                    </button>
                    <div class="dropdown-menu">
                        <a class="dropdown-item" href="?search={{ search }}&sort_by=created_at&sort_order=desc&per_page={{ per_page }}">
                            <i class="fas fa-clock"></i> Newest Created
                        </a>
                        <a class="dropdown-item" href="?search={{ search }}&sort_by=created_at&sort_order=asc&per_page={{ per_page }}">
                            <i class="fas fa-clock"></i> Oldest Created
                        </a>
                        <a class="dropdown-item" href="?search={{ search }}&sort_by=updated_at&sort_order=desc&per_page={{ per_page }}">
                            <i class="fas fa-sync"></i> Newest Updated
                        </a>
                        <a class="dropdown-item" href="?search={{ search }}&sort_by=updated_at&sort_order=asc&per_page={{ per_page }}">
                            <i class="fas fa-sync"></i> Oldest Updated
                        </a>
                        <a class="dropdown-item" href="?search={{ search }}&sort_by=name&sort_order=asc&per_page={{ per_page }}">
                            <i class="fas fa-sort-alpha-down"></i> A-Z
                        </a>
                        <a class="dropdown-item" href="?search={{ search }}&sort_by=name&sort_order=desc&per_page={{ per_page }}">
                            <i class="fas fa-sort-alpha-up"></i> Z-A
                        </a>
                    </div>
                </div>
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle dropdown-pagination" type="button" data-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-list"></i> {{ per_page }} per page
                    </button>
                    <div class="dropdown-menu">
                        <a class="dropdown-item" href="?search={{ search }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}&per_page=10">10 per page</a>
                        <a class="dropdown-item" href="?search={{ search }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}&per_page=25">25 per page</a>
                        <a class="dropdown-item" href="?search={{ search }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}&per_page=50">50 per page</a>
                        <a class="dropdown-item" href="?search={{ search }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}&per_page=100">100 per page</a>
                    </div>
                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bulk Actions Toolbar -->
                    <div id="bulkActionsToolbar" class="alert alert-info mx-3 d-none" role="alert">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-info-circle mr-2"></i>
                                <span id="selectedCount" class="fw-bold">0</span> datasets selected
                            </div>
                            <div>
                                <button type="button" class="btn btn-success mr-2 btn-bulk-action" onclick="bulkCleanDatasets()">
                                    <i class="fas fa-broom"></i> Clean
                                </button>
                                <!-- Klasifikasi bulk dinonaktifkan: gunakan klasifikasi per dataset -->
                                <button type="button" class="btn btn-danger mr-2 btn-bulk-action" onclick="bulkDeleteDatasets()">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                                <button type="button" class="btn btn-secondary btn-bulk-action" onclick="clearSelection()">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dataset Table -->
                    {% if dataset_stats %}
                    <div class="table-responsive table-container">
                        <table class="table align-items-center mb-0">
                            <thead>
                                <tr>
                                    <th class="text-center" style="width: 50px;">
                                        <div class="form-check d-flex justify-content-center align-items-center mb-0">
                                            <input class="form-check-input" type="checkbox" id="selectAllCheckbox">
                                        </div>
                                    </th>
                                    <th class="dataset-column">Dataset</th>
                                    <th class="content-column">Content</th>
                                    <th class="username-column">Username</th>
                                    <th class="text-center url-column">URL</th>
                                    <th class="text-center stats-column">Statistics</th>
                                    <th class="text-center status-column">Status</th>
                                    <th class="text-center date-column">Date</th>
                                    <th class="text-center action-column">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stat in dataset_stats %}
                                <tr>
                                    <td class="text-center">
                                        <div class="form-check d-flex justify-content-center align-items-center mb-0">
                                            <input class="form-check-input dataset-checkbox" type="checkbox" value="{{ stat.dataset.id }}">
                                        </div>
                                    </td>
                                    <td class="dataset-cell">
                                        <h6 class="dataset-title" title="{{ stat.dataset.name }}">{{ stat.dataset.name }}</h6>
                                        <p class="mb-0 d-flex align-items-center gap-2">
                                            {% if stat.raw_upload_count > 0 %}
                                                <span class="d-inline-flex align-items-center">
                                                    <i class="fas fa-upload text-info mr-1"></i> Upload
                                                </span>
                                            {% endif %}
                                            {% if stat.raw_scraper_count > 0 %}
                                                {% if stat.raw_upload_count > 0 %}
                                                    <span class="text-muted mx-1">|</span>
                                                {% endif %}
                                                <span class="d-inline-flex align-items-center">
                                                    <i class="fas fa-spider text-warning mr-1"></i> Scraping
                                                </span>
                                            {% endif %}
                                        </p>
                                    </td>
                                    <td class="content-column">
                                        <p class="content-text mb-0" title="{{ stat.sample_content }}">
                                            {% if stat.sample_content and stat.sample_content != '-' %}
                                                {{ stat.sample_content[:100] }}{% if stat.sample_content|length > 100 %}...{% endif %}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </p>
                                    </td>
                                    <td class="username-column">
                                        <span class="username-text">
                                            {% if stat.sample_username and stat.sample_username != '-' and stat.sample_username != 'nan' %}
                                                {{ stat.sample_username }}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </span>
                                    </td>
                                    <td class="text-center url-column">
                                        {% if stat.sample_url != '-' %}
                                            <a href="{{ stat.sample_url }}" target="_blank" rel="noopener noreferrer" class="url-icon" title="{{ stat.sample_url }}" aria-label="Open URL">
                                                <i class="fas fa-external-link-alt"></i>
                                            </a>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center stats-column">
                                        <div class="stats-container">
                                            <div class="stats-item">
                                                <span class="stats-label">Total</span>
                                                <div class="stats-value">
                                                    <i class="fas fa-database"></i>
                                                    <span>{{ stat.total_records }}</span>
                                                </div>
                                            </div>
                                            <div class="stats-item">
                                                <span class="stats-label">Clean</span>
                                                <div class="stats-value">
                                                    <i class="fas fa-broom"></i>
                                                    <span>{{ stat.clean_count }}</span>
                                                </div>
                                            </div>
                                            <div class="stats-item">
                                                <span class="stats-label">Classified</span>
                                                <div class="stats-value">
                                                    <i class="fas fa-check"></i>
                                                    <span>{{ stat.classified_count }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-center status-column">
                                        {% if stat.classified_count > 0 %}
                                            <span class="status-badge classified">
                                                <i class="fas fa-check-circle"></i> {{ t('Classified') }}
                                            </span>
                                        {% elif stat.clean_count > 0 %}
                                            <span class="status-badge cleaned">
                                                <i class="fas fa-broom"></i> {{ t('Cleaned') }}
                                            </span>
                                        {% else %}
                                            <span class="status-badge raw">
                                                <i class="fas fa-file-alt"></i> {{ t('Raw') }}
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center date-column">
                                        <div class="d-flex flex-column align-items-center">
                                            <span class="text-xs text-muted mb-1">
                                                <i class="far fa-calendar-alt me-1"></i>
                                                {{ stat.dataset.created_at|format_datetime('datetime') if stat.dataset.created_at else '-' }}
                                            </span>
                                            <span class="text-xs text-muted">
                                                <i class="fas fa-sync-alt me-1"></i>
                                                {{ stat.dataset.updated_at|format_datetime('datetime') if stat.dataset.updated_at else '-' }}
                                            </span>
                                        </div>
                                    </td>
                                    <td class="text-center action-column">
                                        <div class="d-flex gap-2 justify-content-center">
                                            <button class="action-btn" title="Detail" onclick="viewDatasetDetails({{ stat.dataset.id }})">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="action-btn" title="Clean" onclick="cleanDataset({{ stat.dataset.id }})">
                                                <i class="fas fa-broom"></i>
                                            </button>
                                            <button class="action-btn" title="Classify" onclick="classifyDataset({{ stat.dataset.id }})">
                                                <i class="fas fa-tags"></i>
                                            </button>
                                            <button class="action-btn text-danger" title="Delete" onclick="deleteDataset({{ stat.dataset.id }})">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-database"></i>
                        </div>
                        <h5 class="empty-state-text">No datasets yet</h5>
                        <p class="text-sm text-muted mb-4">Start by uploading your first dataset</p>
                        <div class="d-flex justify-content-center gap-3">
                            <a href="{{ url_for('dataset.upload_file') }}" class="btn btn-primary mr-2 btn-action">
                                <i class="fas fa-upload mr-1"></i> Upload Data
                            </a>
                            <a href="{{ url_for('scraper.index') }}" class="btn btn-success btn-action">
                                <i class="fas fa-spider mr-1"></i> Scraper Data
                            </a>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Pagination -->
                    {% if pagination and pagination.pages > 1 %}
                    <div class="d-flex justify-content-between align-items-center px-3 mt-4 pt-3 border-top">
                        <div class="text-sm text-muted">
                            Showing {{ (pagination.page - 1) * pagination.per_page + 1 }} - 
                            {{ pagination.page * pagination.per_page if pagination.page * pagination.per_page < pagination.total else pagination.total }} 
                            of {{ pagination.total }} datasets
                        </div>
                        <nav aria-label="Dataset pagination">
                            <ul class="pagination pagination-sm mb-0">
                                {% if pagination.has_prev %}
                                <li class="page-item">
                                    <a class="page-link" href="?search={{ search }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}&per_page={{ per_page }}&page={{ pagination.prev_num }}">
                                        <i class="fas fa-chevron-left"></i>
                                    </a>
                                </li>
                                {% endif %}
                                
                                {% for page_num in pagination.iter_pages() %}
                                    {% if page_num %}
                                        {% if page_num != pagination.page %}
                                        <li class="page-item">
                                            <a class="page-link" href="?search={{ search }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}&per_page={{ per_page }}&page={{ page_num }}">{{ page_num }}</a>
                                        </li>
                                        {% else %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ page_num }}</span>
                                        </li>
                                        {% endif %}
                                    {% else %}
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                    {% endif %}
                                {% endfor %}
                                
                                {% if pagination.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?search={{ search }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}&per_page={{ per_page }}&page={{ pagination.next_num }}">
                                        <i class="fas fa-chevron-right"></i>
                                    </a>
                                </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
    // Open modals if requested by backend
    {% if upload_modal_open %}
    $(document).ready(function() {
        if (typeof showUploadModal === 'function') {
            showUploadModal();
        } else {
            console.error('showUploadModal function is not defined');
            // Fallback attempt to find button
            $('button[onclick="showUploadModal()"]').click();
        }
    });
    {% endif %}
    
    {% if scraper_modal_open %}
    $(document).ready(function() {
        if (typeof showScraperModal === 'function') {
            showScraperModal();
        } else {
            console.error('showScraperModal function is not defined');
            // Fallback attempt to find button
            $('button[onclick="showScraperModal()"]').click();
        }
    });
    {% endif %}
    
$(document).ready(function() {
        // Bulk operations JavaScript (same as card view)
    function updateBulkToolbar() {
        const selectedCheckboxes = $('.dataset-checkbox:checked');
        const toolbar = $('#bulkActionsToolbar');
        const selectedCount = $('#selectedCount');
        
        if (selectedCheckboxes.length > 0) {
            toolbar.removeClass('d-none');
            selectedCount.text(selectedCheckboxes.length);
        } else {
            toolbar.addClass('d-none');
        }
    }
    
    // Make function available globally
    window.updateBulkToolbar = updateBulkToolbar;

    
    // Select all functionality
    $('#selectAllCheckbox').change(function() {
        $('.dataset-checkbox').prop('checked', this.checked);
        updateBulkToolbar();
    });
    
    // Individual checkbox functionality
    $(document).on('change', '.dataset-checkbox', function() {
        const totalCheckboxes = $('.dataset-checkbox').length;
        const checkedCheckboxes = $('.dataset-checkbox:checked').length;
        
        $('#selectAllCheckbox').prop('checked', totalCheckboxes === checkedCheckboxes);
        updateBulkToolbar();
    });
    
    // Define functions globally after jQuery is loaded
    window.clearSelection = function() {
        $('.dataset-checkbox, #selectAllCheckbox').prop('checked', false);
        updateBulkToolbar();
    };

    // Dataset operations functions (same as card view)
    window.viewDatasetDetails = function(datasetId) {
        window.location.href = `/dataset/${datasetId}/details`;
    };

    window.cleanDataset = function(datasetId) {
        Swal.fire({
            title: 'Confirm Cleaning',
            text: 'Are you sure you want to clean this dataset?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Yes, Clean',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                const csrfToken = $('meta[name=csrf-token]').attr('content');
                $.ajax({
                    url: `/api/dataset/${datasetId}/clean`,
                    type: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken
                    },
                    success: function(data) {
                        if (data.success) {
                            if (data.task_id) {
                                const taskId = data.task_id;
                                
                                // Show progress bar with details
                                Swal.fire({
                                    title: 'Cleaning Data...',
                                    html: `
                                        <div class="mb-2">Processing dataset...</div>
                                        <div class="progress" style="height: 25px;">
                                            <div id="cleaning-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                        </div>
                                        <div class="mt-3 text-start small">
                                            <div class="d-flex justify-content-between">
                                                <span>Processed:</span>
                                                <span id="processed-count">0</span>
                                            </div>
                                            <div class="d-flex justify-content-between text-success">
                                                <span>Cleaned:</span>
                                                <span id="cleaned-count">0</span>
                                            </div>
                                            <div class="d-flex justify-content-between text-warning">
                                                <span>Ignored (Duplicate):</span>
                                                <span id="ignored-count">0</span>
                                            </div>
                                            <div class="d-flex justify-content-between fw-bold border-top mt-1 pt-1">
                                                <span>Total:</span>
                                                <span id="total-count">0</span>
                                            </div>
                                        </div>
                                    `,
                                    allowOutsideClick: false,
                                    showConfirmButton: false,
                                    didOpen: () => {
                                        Swal.showLoading();
                                    }
                                });
                                
                                // Poll for progress
                                const pollInterval = setInterval(() => {
                                    $.ajax({
                                        url: `/dataset/bulk/clean/progress/${taskId}`,
                                        type: 'GET',
                                        success: function(progressData) {
                                            const progressBar = document.getElementById('cleaning-progress-bar');
                                            
                                            if (progressBar) {
                                                const percentage = progressData.progress || 0;
                                                const current = progressData.current || 0;
                                                const total = progressData.total || 0;
                                                const ignored = progressData.ignored_count || 0;
                                                const cleaned = current - ignored;
                                                
                                                progressBar.style.width = `${percentage}%`;
                                                progressBar.innerText = `${percentage}%`;
                                                progressBar.setAttribute('aria-valuenow', percentage);
                                                
                                                // Update stats
                                                $('#processed-count').text(current);
                                                $('#cleaned-count').text(cleaned);
                                                $('#ignored-count').text(ignored);
                                                $('#total-count').text(total);
                                                
                                                // Add color classes based on progress
                                                progressBar.classList.remove('bg-danger', 'bg-warning', 'bg-success');
                                                if (percentage < 33) {
                                                    progressBar.classList.add('bg-danger');
                                                } else if (percentage < 66) {
                                                    progressBar.classList.add('bg-warning');
                                                } else {
                                                    progressBar.classList.add('bg-success');
                                                }
                                            }
                                            
                                            if (progressData.status === 'completed') {
                                                clearInterval(pollInterval);
                                                Swal.fire({
                                                    icon: 'success',
                                                    title: 'Done!',
                                                    text: progressData.message,
                                                    confirmButtonText: 'OK'
                                                }).then(() => location.reload());
                                            } else if (progressData.status === 'error') {
                                                clearInterval(pollInterval);
                                                Swal.fire({
                                                    icon: 'error',
                                                    title: 'Failed',
                                                    text: progressData.message || 'An error occurred while cleaning data',
                                                    confirmButtonText: 'Close'
                                                });
                                            }
                                        },
                                        error: function() {
                                            clearInterval(pollInterval);
                                            Swal.fire({
                                                icon: 'error',
                                                title: 'Connection Lost',
                                                text: 'Failed to monitor cleaning progress.',
                                                confirmButtonText: 'Close'
                                            });
                                        }
                                    });
                                }, 1000);
                            } else if (data.already_cleaned) {
                                Swal.fire({
                                    title: 'Info',
                                    text: data.message,
                                    icon: 'info',
                                    confirmButtonText: 'OK'
                                });
                            } else {
                                // Fallback for sync response (should not happen with new async logic)
                                Swal.fire({
                                    title: 'Success!',
                                    text: `${data.cleaned_count} data cleaned`,
                                    icon: 'success',
                                    confirmButtonText: 'OK'
                                }).then(() => location.reload());
                            }
                        } else {
                            Swal.fire({
                                title: 'Error',
                                text: data.message,
                                icon: 'error',
                                confirmButtonText: 'OK'
                            });
                        }
                    },
                    error: function(xhr, status, error) {
                        let errorMessage = 'Failed to clean dataset';
                        try {
                            const response = JSON.parse(xhr.responseText);
                            if (response.message) errorMessage = response.message;
                        } catch (e) {}
                        
                        Swal.fire({
                            title: 'Error',
                            text: errorMessage,
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    }
                });
            }
        });
    };

    window.classifyDataset = function(datasetId) {
        // Redirect to classification page with dataset preview
        window.location.href = `/classification?dataset_id=${datasetId}`;
    };

    window.deleteDataset = function(datasetId) {
        Swal.fire({
            title: 'Confirm Deletion',
            text: 'Are you sure you want to delete this dataset? This action cannot be undone.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, Delete',
            cancelButtonText: 'Cancel',
            confirmButtonColor: '#d33'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: `/api/dataset/${datasetId}`,
                    type: 'DELETE',
                    headers: {
                        'X-CSRFToken': $('meta[name=csrf-token]').attr('content')
                    },
                    success: function(data) {
                        if (data.success) {
                            if (typeof swalSuccess === 'function') {
                                swalSuccess('Success', 'Dataset deleted successfully').then(() => {
                                    location.reload();
                                    // Update dashboard stats after successful deletion
                                    updateDashboardStatsAfterDeletion();
                                });
                            } else {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Success',
                                    text: 'Dataset deleted successfully',
                                    customClass: {
                                        popup: 'swal2-popup',
                                        title: 'swal2-title',
                                        htmlContainer: 'swal2-html-container',
                                        actions: 'swal2-actions',
                                        confirmButton: 'swal2-confirm'
                                    }
                                }).then(() => {
                                    location.reload();
                                    // Update dashboard stats after successful deletion
                                    updateDashboardStatsAfterDeletion();
                                });
                            }
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: data.message,
                                customClass: {
                                    popup: 'swal2-popup',
                                    title: 'swal2-title',
                                    htmlContainer: 'swal2-html-container',
                                    actions: 'swal2-actions',
                                    confirmButton: 'swal2-confirm'
                                }
                            });
                        }
                    },
                    error: function() {
                        if (typeof swalError === 'function') {
                            swalError('Error', 'Failed to delete dataset');
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'Failed to delete dataset',
                                customClass: {
                                    popup: 'swal2-popup',
                                    title: 'swal2-title',
                                    htmlContainer: 'swal2-html-container',
                                    actions: 'swal2-actions',
                                    confirmButton: 'swal2-confirm'
                                }
                            });
                        }
                    }
                });
            }
        });
    };

    // Bulk operations functions
    window.bulkCleanDatasets = function() {
        const selectedIds = $('.dataset-checkbox:checked').map(function() {
            return $(this).val();
        }).get();
        
        if (selectedIds.length === 0) {
            if (typeof swalWarning === 'function') {
                swalWarning('Warning', 'Select at least one dataset to clean');
            } else {
                Swal.fire({
                    icon: 'warning',
                    title: 'Warning',
                    text: 'Select at least one dataset to clean',
                    customClass: {
                        popup: 'swal2-popup',
                        title: 'swal2-title',
                        htmlContainer: 'swal2-html-container',
                        actions: 'swal2-actions',
                        confirmButton: 'swal2-confirm'
                    }
                });
            }
            return;
        }
    
        Swal.fire({
            title: 'Confirm Bulk Cleaning',
            text: `Are you sure you want to clean ${selectedIds.length} datasets?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Yes, Clean All',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                const csrfToken = $('meta[name=csrf-token]').attr('content');
                
                $.ajax({
                    url: '/dataset/bulk/clean',
                    type: 'POST',
                    contentType: 'application/json',
                    headers: {
                        'X-CSRFToken': csrfToken
                    },
                    data: JSON.stringify({ dataset_ids: selectedIds }),
                    success: function(data) {
                        if (data.success) {
                            const taskId = data.task_id;
                            
                            // Show progress bar
                            Swal.fire({
                                title: 'Cleaning Data...',
                                html: `
                                    <div class="progress" style="height: 25px;">
                                        <div id="cleaning-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                    </div>
                                    <p class="mt-2" id="cleaning-status-text">Starting process...</p>
                                `,
                                allowOutsideClick: false,
                                showConfirmButton: false,
                                didOpen: () => {
                                    Swal.showLoading();
                                }
                            });
                            
                            // Poll for progress
                            const pollInterval = setInterval(() => {
                                $.ajax({
                                    url: `/dataset/bulk/clean/progress/${taskId}`,
                                    type: 'GET',
                                    success: function(progressData) {
                                        const progressBar = document.getElementById('cleaning-progress-bar');
                                        const statusText = document.getElementById('cleaning-status-text');
                                        
                                        if (progressBar && statusText) {
                                            const percentage = progressData.progress || 0;
                                            progressBar.style.width = `${percentage}%`;
                                            progressBar.innerText = `${percentage}%`;
                                            progressBar.setAttribute('aria-valuenow', percentage);
                                            statusText.innerText = `${progressData.message || 'Processing data...'} (${progressData.current}/${progressData.total})`;
                                            
                                            // Add color classes based on progress
                                            progressBar.classList.remove('bg-danger', 'bg-warning', 'bg-success');
                                            if (percentage < 33) {
                                                progressBar.classList.add('bg-danger');
                                            } else if (percentage < 66) {
                                                progressBar.classList.add('bg-warning');
                                            } else {
                                                progressBar.classList.add('bg-success');
                                            }
                                        }
                                        
                                        if (progressData.status === 'completed') {
                                            clearInterval(pollInterval);
                                            Swal.fire({
                                                icon: 'success',
                                                title: 'Done!',
                                                text: progressData.message,
                                                confirmButtonText: 'OK'
                                            }).then(() => location.reload());
                                        } else if (progressData.status === 'error') {
                                            clearInterval(pollInterval);
                                            Swal.fire({
                                                icon: 'error',
                                                title: 'Failed',
                                                text: progressData.message || 'An error occurred while cleaning data',
                                                confirmButtonText: 'Close'
                                            });
                                        }
                                    },
                                    error: function() {
                                        clearInterval(pollInterval);
                                        Swal.fire({
                                            icon: 'error',
                                            title: 'Connection Lost',
                                            text: 'Failed to monitor cleaning progress.',
                                            confirmButtonText: 'Close'
                                        });
                                    }
                                });
                            }, 1000);
                            
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Failed to Start',
                                text: data.message,
                                confirmButtonText: 'Close'
                            });
                        }
                    },
                    error: function(xhr) {
                        let errorMessage = 'Failed to connect to server';
                        try {
                            const response = JSON.parse(xhr.responseText);
                            if (response.message) errorMessage = response.message;
                        } catch(e) {}
                        
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: errorMessage,
                            confirmButtonText: 'Close'
                        });
                    }
                });
            }
        });
    };

    window.bulkClassifyDatasets = function() {
        const selectedIds = $('.dataset-checkbox:checked').map(function() {
            return $(this).val();
        }).get();
        
        if (selectedIds.length === 0) {
            if (typeof swalWarning === 'function') {
                swalWarning('Warning', 'Select at least one dataset to classify');
            } else {
                Swal.fire({
                    icon: 'warning',
                    title: 'Warning',
                    text: 'Select at least one dataset to classify',
                    customClass: {
                        popup: 'swal2-popup',
                        title: 'swal2-title',
                        htmlContainer: 'swal2-html-container',
                        actions: 'swal2-actions',
                        confirmButton: 'swal2-confirm'
                    }
                });
            }
            return;
        }

        Swal.fire({
            title: 'Confirm Bulk Classification',
            text: `Are you sure you want to classify ${selectedIds.length} datasets?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Yes, Classify All',
            cancelButtonText: 'Cancel',
            confirmButtonColor: '#28a745',
            customClass: {
                popup: 'swal2-popup',
                title: 'swal2-title',
                htmlContainer: 'swal2-html-container',
                actions: 'swal2-actions',
                confirmButton: 'swal2-confirm',
                cancelButton: 'swal2-cancel'
            }
        }).then((result) => {
            if (result.isConfirmed) {
                // Show loading state
                Swal.fire({
                    title: 'Processing Classification...',
                    html: 'Please wait, classification process is running.<br>Do not close this page.',
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                $.ajax({
                    url: '/api/classify_selected_datasets',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ dataset_ids: selectedIds }),
                    headers: {
                        'X-CSRFToken': $('meta[name=csrf-token]').attr('content')
                    },
                    success: function(data) {
                        if (data.success) {
                            let message = `${data.processed} datasets classified successfully`;
                            if (data.errors && data.errors.length > 0) {
                                message += `\n\nNotes/Errors:\n${data.errors.join('\n')}`;
                            }
                            
                            Swal.fire({
                                icon: 'success',
                                title: 'Success',
                                text: message,
                                confirmButtonText: 'OK'
                            }).then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Failed',
                                text: data.message,
                                confirmButtonText: 'Close'
                            });
                        }
                    },
                    error: function(xhr) {
                        let errorMessage = 'Failed to connect to server';
                        try {
                            const response = JSON.parse(xhr.responseText);
                            if (response.message) errorMessage = response.message;
                        } catch(e) {}
                        
                        // Use HTML to display newlines properly if needed, but text usually works.
                        // Since I added newlines in backend (\n), Swal2 'text' handles them.
                        // However, for complex formatting, we can check.
                        
                        Swal.fire({
                            icon: 'error',
                            title: 'Validation Failed',
                            text: errorMessage,
                            confirmButtonText: 'Understood',
                            customClass: {
                                popup: 'swal2-popup',
                                title: 'swal2-title',
                                htmlContainer: 'swal2-html-container',
                                actions: 'swal2-actions',
                                confirmButton: 'swal2-confirm'
                            }
                        });
                    }
                });
            }
        });
    };

    window.bulkDeleteDatasets = function() {
        const selectedIds = $('.dataset-checkbox:checked').map(function() {
            return $(this).val();
        }).get();
        
        if (selectedIds.length === 0) {
            if (typeof swalWarning === 'function') {
                swalWarning('Warning', 'Select datasets first');
            } else {
                Swal.fire({
                    icon: 'warning',
                    title: 'Warning',
                    text: 'Select datasets first',
                    customClass: {
                        popup: 'swal2-popup',
                        title: 'swal2-title',
                        htmlContainer: 'swal2-html-container',
                        actions: 'swal2-actions',
                        confirmButton: 'swal2-confirm'
                    }
                });
            }
            return;
        }
        
        Swal.fire({
            title: 'Confirm Bulk Delete',
            text: `Are you sure you want to delete ${selectedIds.length} datasets? This action cannot be undone.`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, Delete All',
            cancelButtonText: 'Cancel',
            confirmButtonColor: '#d33'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: '/dataset/bulk/delete',
                    type: 'POST',
                    contentType: 'application/json',
                    headers: {
                        'X-CSRFToken': $('meta[name=csrf-token]').attr('content')
                    },
                    data: JSON.stringify({ dataset_ids: selectedIds }),
                    success: function(data) {
                        if (data.success) {
                            let message = `${data.processed} datasets deleted successfully`;
                            if (data.errors && data.errors.length > 0) {
                                message += `\n\nErrors on some datasets:\n${data.errors.join('\n')}`;
                            }
                            if (typeof swalSuccess === 'function') {
                                swalSuccess('Success', message).then(() => {
                                    location.reload();
                                    updateDashboardStatsAfterDeletion();
                                });
                            } else {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Success',
                                    text: message,
                                    customClass: {
                                        popup: 'swal2-popup',
                                        title: 'swal2-title',
                                        htmlContainer: 'swal2-html-container',
                                        actions: 'swal2-actions',
                                        confirmButton: 'swal2-confirm'
                                    }
                                }).then(() => {
                                    location.reload();
                                    updateDashboardStatsAfterDeletion();
                                });
                            }
                        } else {
                            if (typeof swalError === 'function') {
                                swalError('Error', data.message);
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: data.message,
                                    customClass: {
                                        popup: 'swal2-popup',
                                        title: 'swal2-title',
                                        htmlContainer: 'swal2-html-container',
                                        actions: 'swal2-actions',
                                        confirmButton: 'swal2-confirm'
                                    }
                                });
                            }
                        }
                    },
                    error: function() {
                        if (typeof swalError === 'function') {
                            swalError('Error', 'Failed to delete datasets');
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'Failed to delete datasets',
                                customClass: {
                                    popup: 'swal2-popup',
                                    title: 'swal2-title',
                                    htmlContainer: 'swal2-html-container',
                                    actions: 'swal2-actions',
                                    confirmButton: 'swal2-confirm'
                                }
                            });
                        }
                    }
                });
            }
        });
    };
    
    // Function to update dashboard stats after deletion
    function updateDashboardStatsAfterDeletion() {
        fetch('/dashboard/stats')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                
                // We don't need to update UI here since we're reloading the page
                // This is just to trigger the statistics update on the server side
            })
            .catch(error => {
                console.error('Error updating dashboard stats after deletion:', error);
            });
    }
    
    // All bulk operation functions are now defined
});
</script>
{% endblock extra_js %}