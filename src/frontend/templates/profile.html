{% extends "base.html" %}
{% block title %}User Profile - Waskita{% endblock title %}
{% block page_title %}
    User Profile
{% endblock page_title %}
{% block breadcrumb %}
    <li class="breadcrumb-item">
        <a href="{{ url_for("main.dashboard") }}">Home</a>
    </li>
    <li class="breadcrumb-item active">Profile</li>
{% endblock breadcrumb %}
{% block content %}
        <!-- Main content -->
        <section class="content">
            <div class="container-fluid">
                <div class="row">
                    <!-- Profile Information -->
                    <div class="col-md-4 d-flex flex-column">
                        <div class="card">
                            <div class="card-body box-profile">
                                <div class="text-center">
                                    <i class="fas fa-user-circle fa-5x text-secondary mb-3"></i>
                                    <h3 class="profile-username text-center">{{ current_user.username }}</h3>
                                    <p class="text-muted text-center">
                                        {% if current_user.is_admin() %}
                                            <span class="badge bg-secondary"><i class="fas fa-crown mr-1"></i>Administrator</span>
                                        {% else %}
                                            <span class="badge bg-secondary"><i class="fas fa-user mr-1"></i>User</span>
                                        {% endif %}
                                    </p>
                                </div>
                                <ul class="list-group list-group-unbordered mb-3">
                                    <li class="list-group-item">
                                        <b>Total Uploads</b> <a class="float-right">{{ user_stats.total_uploads or 0 }}</a>
                                    </li>
                                    <li class="list-group-item">
                                        <b>Processed Data</b> <a class="float-right">{{ user_stats.total_processed or 0 }}</a>
                                    </li>
                                    <li class="list-group-item">
                                        <b>Classifications</b> <a class="float-right">{{ user_stats.total_classifications or 0 }}</a>
                                    </li>
                                    <li class="list-group-item">
                                        <b>Joined</b> <a class="float-right">{{ current_user.created_at|format_datetime('date') }}</a>
                                    </li>
                                    <li class="list-group-item">
                                        <b>Last Login</b>
                                        <a class="float-right">
                                            {% if current_user.last_login %}
                                                {{ current_user.last_login|format_datetime('date') }}
                                            {% else %}
                                                Never
                                            {% endif %}
                                        </a>
                                    </li>
                                </ul>
                                <button class="btn btn-secondary btn-block" onclick="showEditProfileModal()">
                                    <i class="fas fa-edit mr-2"></i>Edit Profile
                                </button>
                            </div>
                        </div>
                        <!-- Account Security -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-shield-alt mr-2"></i>Account Security
                                </h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label>Account Status:</label>
                                    <div>
                                        <span class="badge badge-{{ 'success' if current_user.is_active else 'danger' }} badge-lg">
                                            {{ 'Active' if current_user.is_active else 'Inactive' }}
                                        </span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Password Security:</label>
                                    <div class="password-security-indicator">
                                        <div class="security-level">
                                            <span>Security Status</span>
                                            <span class="security-level-badge security-strong" id="securityBadge">
                                                <i class="fas fa-shield-alt"></i>
                                                Strong
                                            </span>
                                        </div>
                                        
                                        <div class="security-progress">
                                            <div class="security-progress-bar security-progress-strong" id="securityProgressBar"></div>
                                        </div>
                                        

                                        
                                        <div class="password-last-changed">
                                            <span>
                                                <i class="fas fa-clock mr-1"></i>
                                                Last changed: 
                                                <span id="lastPasswordChange">
                                                    {% if current_user.password_changed_at is defined and current_user.password_changed_at %}
                                                        {{ current_user.password_changed_at|format_datetime('date') }}
                                                    {% else %}
                                                        Never
                                                    {% endif %}
                                                </span>
                                            </span>
                                            <span class="password-age-warning" id="passwordAgeWarning" style="display: none;">
                                                <i class="fas fa-exclamation-triangle"></i>
                                                Needs update
                                            </span>
                                        </div>
                                        
                                        <div class="security-recommendations" id="securityRecommendations" style="display: none;">
                                            <h6><i class="fas fa-lightbulb mr-1"></i>Security Recommendations</h6>
                                            <ul id="recommendationsList">
                                                <li>Use a mix of uppercase and lowercase letters</li>
                                                <li>Add special characters (!@#$%^&*)</li>
                                                <li>Increase password length (minimum 12 characters)</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <button class="btn btn-secondary btn-block" onclick="showChangePasswordModal()">
                                    <i class="fas fa-key mr-2"></i>Change Password
                                </button>
                            </div>
                        </div>
                        <!-- Recent Activity -->
                        <div class="card flex-grow-1">
                            <header class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-clock mr-1" aria-hidden="true"></i>
                                    Recent Activities
                                </h3>
                                <div class="card-tools">
                                    <button type="button" class="btn btn-secondary btn-sm" onclick="refreshActivity()">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                            </header>
                            <main class="card-body p-3 d-flex flex-column">
                                <div class="activity-list flex-grow-1" role="log" aria-label="Recent activity timeline" aria-live="polite">
                                    {% if recent_activities %}
                                        <div class="timeline-wrapper">
                                            {% for activity in recent_activities %}
                                                <div class="timeline-item">
                                                    <div class="timeline-marker marker-{{ activity.type_color }}"></div>
                                                    <div class="timeline-content">
                                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                                            <span class="font-weight-bold text-dark" style="font-size: 0.9rem;">{{ activity.title }}</span>
                                                            <small class="text-muted" style="font-size: 0.75rem;">{{ activity.time }}</small>
                                                        </div>
                                                        <p class="text-muted mb-0 text-sm" style="line-height: 1.4;">
                                                            {{ activity.description }}
                                                        </p>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <div class="text-center text-muted py-5 h-100 d-flex flex-column justify-content-center align-items-center">
                                            <div class="mb-3">
                                                <i class="fas fa-history fa-3x text-light"></i>
                                            </div>
                                            <p class="mb-0">No recent activity</p>
                                        </div>
                                    {% endif %}
                                </div>
                            </main>
                        </div>
                    </div>
                    <!-- Activity and Settings -->
                    <div class="col-md-8 d-flex flex-column">
                        <!-- Activity Statistics -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-chart-line mr-2"></i>Activity Statistics
                                </h3>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3 col-sm-6 col-12">
                                        <div class="info-box">
                                            <span class="info-box-icon bg-info elevation-1"><i class="fas fa-upload"></i></span>
                                            <div class="info-box-content">
                                                <span class="info-box-text">Manual Uploads</span>
                                                <span class="info-box-number">{{ user_stats.manual_uploads or 0 }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-sm-6 col-12">
                                        <div class="info-box">
                                            <span class="info-box-icon bg-success elevation-1"><i class="fas fa-robot"></i></span>
                                            <div class="info-box-content">
                                                <span class="info-box-text">Scraping</span>
                                                <span class="info-box-number">{{ user_stats.scraping_count or 0 }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-sm-6 col-12">
                                        <div class="info-box">
                                            <span class="info-box-icon bg-warning elevation-1"><i class="fas fa-broom"></i></span>
                                            <div class="info-box-content">
                                                <span class="info-box-text">Data Cleaned</span>
                                                <span class="info-box-number">{{ user_stats.cleaned_data or 0 }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-sm-6 col-12">
                                        <div class="info-box">
                                            <span class="info-box-icon bg-danger elevation-1"><i class="fas fa-brain"></i></span>
                                            <div class="info-box-content">
                                                <span class="info-box-text">Classified</span>
                                                <span class="info-box-number">{{ user_stats.total_classifications or 0 }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Activity Chart -->
                                <div class="chart" style="position: relative; height: 400px;">
                                    <canvas id="activityChart" class="activity-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Preferences -->
                        <div class="card flex-grow-1">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-cog mr-2"></i>Preferences
                                </h3>
                            </div>
                            <div class="card-body">
                                <form id="preferencesForm">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="language">Language</label>
                                                <select class="form-control" id="language">
                                                    <option value="id" {% if current_user.get_preferences().get('language') == 'id' %}selected{% endif %}>Bahasa Indonesia</option>
                                                    <option value="en" {% if current_user.get_preferences().get('language') == 'en' %}selected{% endif %}>English</option>
                                                </select>
                                            </div>
                                            <div class="form-group">
                                                <label for="timezone">Timezone</label>
                                                <select class="form-control" id="timezone">
                                                    <option value="Asia/Jakarta" {% if current_user.get_preferences().get('timezone') == 'Asia/Jakarta' %}selected{% endif %}>Asia/Jakarta (WIB)</option>
                                                    <option value="Asia/Makassar" {% if current_user.get_preferences().get('timezone') == 'Asia/Makassar' %}selected{% endif %}>Asia/Makassar (WITA)</option>
                                                    <option value="Asia/Jayapura" {% if current_user.get_preferences().get('timezone') == 'Asia/Jayapura' %}selected{% endif %}>Asia/Jayapura (WIT)</option>
                                                </select>
                                            </div>
                                            <div class="form-group">
                                                <label for="itemsPerPage">Items Per Page</label>
                                                <select class="form-control" id="itemsPerPage">
                                                    <option value="10" {% if current_user.get_preferences().get('items_per_page') == 10 %}selected{% endif %}>10</option>
                                                    <option value="25" {% if current_user.get_preferences().get('items_per_page') == 25 %}selected{% endif %}>25</option>
                                                    <option value="50" {% if current_user.get_preferences().get('items_per_page') == 50 %}selected{% endif %}>50</option>
                                                    <option value="100" {% if current_user.get_preferences().get('items_per_page') == 100 %}selected{% endif %}>100</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <div class="custom-control custom-switch">
                                                    <input type="checkbox" class="custom-control-input" id="emailNotifications" {% if current_user.get_preferences().get('email_notifications') %}checked{% endif %}>
                                                    <label class="custom-control-label" for="emailNotifications">Email Notifications</label>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <div class="custom-control custom-switch">
                                                    <input type="checkbox" class="custom-control-input" id="autoRefresh" {% if current_user.get_preferences().get('auto_refresh') %}checked{% endif %}>
                                                    <label class="custom-control-label" for="autoRefresh">Auto Refresh Data</label>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <div class="custom-control custom-switch">
                                                    <input type="checkbox" class="custom-control-input" id="darkMode" {% if current_user.get_preferences().get('dark_mode') %}checked{% endif %}>
                                                    <label class="custom-control-label" for="darkMode">Dark Mode</label>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <div class="custom-control custom-switch">
                                                    <input type="checkbox" class="custom-control-input" id="compactView" {% if current_user.get_preferences().get('compact_view') %}checked{% endif %}>
                                                    <label class="custom-control-label" for="compactView">Compact View</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <button type="button" class="btn btn-primary" onclick="savePreferences()">
                                                <i class="fas fa-save mr-2"></i>Save Preferences
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    <!-- Edit Profile Modal -->
    <div class="modal fade" id="editProfileModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-edit mr-2"></i>Edit Profile
                    </h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>×</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="editProfileForm">
                        <div class="form-group">
                            <label for="editUsername">Username:</label>
                            <input type="text"
                                   class="form-control"
                                   id="editUsername"
                                   value="{{ current_user.username }}"
                                   readonly>
                            <small class="form-text text-muted">Username cannot be changed</small>
                        </div>
                        <div class="form-group">
                            <label for="editEmail">Email:</label>
                            <input type="email"
                                   class="form-control"
                                   id="editEmail"
                                   value="{{ current_user.email }}"
                                   required>
                        </div>
                        <div class="form-group">
                            <label for="editFullName">Full Name:</label>
                            <input type="text"
                                   class="form-control"
                                   id="editFullName"
                                   value="{{ current_user.full_name or '' }}">
                        </div>
                        <div class="form-group">
                            <label for="editBio">Bio:</label>
                            <textarea class="form-control"
                                      id="editBio"
                                      rows="3"
                                      placeholder="Tell us about yourself...">{{ current_user.bio or '' }}</textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveProfile()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Change Password Modal -->
    <div class="modal fade"
         id="changePasswordModal"
         tabindex="-1"
         role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-key mr-2"></i>Change Password
                    </h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>×</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">
                        <div class="form-group">
                            <label for="currentPassword">Current Password:</label>
                            <input type="password" class="form-control" id="currentPassword" required>
                        </div>
                        <div class="form-group">
                            <label for="newPassword">New Password:</label>
                            <input type="password" class="form-control" id="newPassword" required>
                            <div class="password-strength mt-2">
                                <div class="progress progress-sm">
                                    <div class="progress-bar" id="passwordStrength"></div>
                                </div>
                                <small class="text-muted" id="passwordStrengthText">Enter new password</small>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="confirmNewPassword">Confirm New Password:</label>
                            <input type="password" class="form-control" id="confirmNewPassword" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="changePassword()">Change Password</button>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}
{% block scripts %}
    <script>
$(document).ready(function() {
    // Initialize activity chart
    initializeActivityChart();
    
    // Password strength checker
    $('#newPassword').on('input', function() {
        checkPasswordStrength($(this).val());
    });

    // Listen to theme changes
    window.addEventListener('themeChanged', function(e) {
        updateChartTheme(e.detail.theme);
    });
});

let activityChart;

function getChartColors() {
    const isDark = document.body.classList.contains('dark-mode');
    return {
        textColor: isDark ? '#f8f9fa' : '#212529',
        gridColor: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
    };
}

function updateChartTheme(theme) {
    if (!activityChart) return;
    const colors = getChartColors();
    activityChart.options.plugins.legend.labels.color = colors.textColor;
    activityChart.options.scales.x.ticks.color = colors.textColor;
    activityChart.options.scales.x.grid.color = colors.gridColor;
    activityChart.options.scales.y.ticks.color = colors.textColor;
    activityChart.options.scales.y.grid.color = colors.gridColor;
    activityChart.update();
}

function initializeActivityChart() {
    // Pastikan Chart.js sudah dimuat
    if (typeof Chart === 'undefined') {
        return;
    }
    
    const ctx = document.getElementById('activityChart').getContext('2d');
    const colors = getChartColors();

    activityChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul'],
            datasets: [
                {
                    label: 'Upload',
                    data: [12, 19, 3, 5, 2, 3, 8],
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Classification',
                    data: [8, 15, 12, 18, 10, 14, 20],
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Cleaning',
                    data: [5, 8, 6, 10, 7, 9, 12],
                    borderColor: '#ffc107',
                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        color: colors.textColor
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: colors.textColor },
                    grid: { color: colors.gridColor }
                },
                x: {
                    ticks: { color: colors.textColor },
                    grid: { color: colors.gridColor }
                }
            }
        }
    });
}

function showEditProfileModal() {
    $('#editProfileModal').modal('show');
}

function saveProfile() {
    const email = $('#editEmail').val();
    const fullName = $('#editFullName').val();
    const bio = $('#editBio').val();
    
    if (!email) {
        Swal.fire({
            icon: 'error',
            title: 'Email Required',
            text: 'Email cannot be empty'
        });
        return;
    }
    
    // Show loading
    Swal.fire({
        title: 'Saving Profile',
        text: 'Processing...',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });
    
    // Send AJAX request to backend
    $.ajax({
        url: '/api/profile/edit',
        method: 'POST',
        headers: {
            'X-CSRFToken': $('meta[name=csrf-token]').attr('content')
        },
        data: {
            email: email,
            full_name: fullName,
            bio: bio
        },
        success: function(response) {
            $('#editProfileModal').modal('hide');
            Swal.fire({
                icon: 'success',
                title: 'Profile Updated Successfully',
                text: response.message
            }).then(() => {
                location.reload();
            });
        },
        error: function(xhr) {
            let errorMessage = 'An error occurred while saving profile';
            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMessage = xhr.responseJSON.message;
            }
            Swal.fire({
                icon: 'error',
                title: 'Failed to Save Profile',
                text: errorMessage
            });
        }
    });
}

function showChangePasswordModal() {
    $('#changePasswordModal').modal('show');
}

function changePassword() {
    const currentPassword = $('#currentPassword').val();
    const newPassword = $('#newPassword').val();
    const confirmNewPassword = $('#confirmNewPassword').val();
    
    if (!currentPassword || !newPassword || !confirmNewPassword) {
        Swal.fire({
            icon: 'error',
            title: 'Incomplete Fields',
            text: 'All password fields must be filled'
        });
        return;
    }
    
    if (newPassword !== confirmNewPassword) {
        Swal.fire({
            icon: 'error',
            title: 'Password Mismatch',
            text: 'New password and confirmation do not match'
        });
        return;
    }
    
    if (newPassword.length < 6) {
        Swal.fire({
            icon: 'error',
            title: 'Password Too Short',
            text: 'New password must be at least 6 characters'
        });
        return;
    }
    
    // Show loading
    Swal.fire({
        title: 'Changing Password',
        text: 'Processing...',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });
    
    // Send AJAX request to backend
    $.ajax({
        url: '/api/profile/change-password',
        method: 'POST',
        headers: {
            'X-CSRFToken': $('meta[name=csrf-token]').attr('content')
        },
        data: {
            current_password: currentPassword,
            new_password: newPassword
        },
        success: function(response) {
            $('#changePasswordModal').modal('hide');
            $('#changePasswordForm')[0].reset();
            Swal.fire({
                icon: 'success',
                title: 'Password Changed Successfully',
                text: response.message
            });
        },
        error: function(xhr) {
            let errorMessage = 'An error occurred while changing password';
            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMessage = xhr.responseJSON.message;
            }
            Swal.fire({
                icon: 'error',
                title: 'Failed to Change Password',
                text: errorMessage
            });
        }
    });
}

function checkPasswordStrength(password) {
    const strengthBar = $('#passwordStrength');
    const strengthText = $('#passwordStrengthText');
    
    let strength = 0;
    let strengthLabel = '';
    let strengthClass = '';
    
    if (password.length >= 6) strength += 1;
    if (password.match(/[a-z]/)) strength += 1;
    if (password.match(/[A-Z]/)) strength += 1;
    if (password.match(/[0-9]/)) strength += 1;
    if (password.match(/[^a-zA-Z0-9]/)) strength += 1;
    
    switch (strength) {
        case 0:
        case 1:
            strengthLabel = 'Very Weak';
            strengthClass = 'bg-danger';
            break;
        case 2:
            strengthLabel = 'Weak';
            strengthClass = 'bg-warning';
            break;
        case 3:
            strengthLabel = 'Medium';
            strengthClass = 'bg-info';
            break;
        case 4:
            strengthLabel = 'Strong';
            strengthClass = 'bg-success';
            break;
        case 5:
            strengthLabel = 'Very Strong';
            strengthClass = 'bg-success';
            break;
    }
    
    const percentage = (strength / 5) * 100;
    strengthBar.removeClass('bg-danger bg-warning bg-info bg-success')
               .addClass(strengthClass)
               .css('width', percentage + '%');
    strengthText.text(strengthLabel);
}

function refreshActivity() {
    // Show loading state
    const refreshBtn = $('.card-tools button');
    const originalIcon = refreshBtn.find('i');
    originalIcon.removeClass('fa-sync-alt').addClass('fa-spinner fa-spin');
    
    // Simulate refresh (replace with actual AJAX call)
    setTimeout(() => {
        originalIcon.removeClass('fa-spinner fa-spin').addClass('fa-sync-alt');
        
        Swal.fire({
            icon: 'success',
            title: 'Activity Updated',
            text: 'Latest activity data has been loaded',
            timer: 2000,
            showConfirmButton: false
        });
    }, 1500);
}

// Save preferences function (if needed for future use)
function savePreferences() {
    const preferences = {
        language: $('#language').val(),
        timezone: $('#timezone').val(),
        items_per_page: $('#itemsPerPage').val(),
        default_dataset: $('#defaultDataset').val(),
        email_notifications: $('#emailNotifications').is(':checked'),
        auto_refresh: $('#autoRefresh').is(':checked'),
        dark_mode: $('#darkMode').is(':checked'),
        auto_classify: $('#autoClassify').is(':checked'),
        show_probability: $('#showProbability').is(':checked'),
        compact_view: $('#compactView').is(':checked')
    };
    
    // Show loading
    Swal.fire({
        title: 'Saving Preferences',
        text: 'Processing...',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });
    
    // Send AJAX request to backend
    $.ajax({
        url: '/api/profile/save-preferences',
        method: 'POST',
        headers: {
            'X-CSRFToken': $('meta[name=csrf-token]').attr('content')
        },
        data: preferences,
        success: function(response) {
            Swal.fire({
                icon: 'success',
                title: 'Preferences Saved',
                text: response.message
            });
        },
        error: function(xhr) {
            let errorMessage = 'An error occurred while saving preferences';
            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMessage = xhr.responseJSON.message;
            }
            Swal.fire({
                icon: 'error',
                title: 'Failed to Save Preferences',
                text: errorMessage
            });
        }
    });
}

// Reset preferences function (if needed for future use)
function resetPreferences() {
    Swal.fire({
        title: 'Reset Preferences?',
        text: 'All preferences will be restored to default settings',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, Reset',
        cancelButtonText: 'Cancel'
    }).then((result) => {
        if (result.isConfirmed) {
            // Reset form values to default
            $('#language').val('en');
            $('#timezone').val('Asia/Jakarta');
            $('#itemsPerPage').val('25');
            $('#defaultDataset').val('');
            $('#emailNotifications').prop('checked', true);
            $('#autoRefresh').prop('checked', false);
            $('#darkMode').prop('checked', true);
            $('#autoClassify').prop('checked', false);
            $('#showProbability').prop('checked', true);
            $('#compactView').prop('checked', false);
            
            Swal.fire({
                icon: 'success',
                title: 'Preferences Reset',
                text: 'All preferences have been restored to default'
            });
        }
    });
}
    </script>
    <style>
/* Timeline Activity List Styling */
.activity-list {
    min-height: 380px;
    height: 100%;
    overflow-y: auto;
    padding-right: 5px;
}

.activity-list::-webkit-scrollbar {
    width: 4px;
}

.activity-list::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.activity-list::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 2px;
}

.activity-list::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

.timeline-wrapper {
    position: relative;
    padding-left: 20px;
    margin-left: 10px;
    border-left: 2px solid #e9ecef;
    padding-top: 5px;
    padding-bottom: 5px;
    min-height: 100%;
}

.timeline-item {
    position: relative;
    padding-bottom: 20px;
}

.timeline-item:last-child {
    padding-bottom: 0;
}

.timeline-marker {
    position: absolute;
    left: -27px;
    top: 4px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background-color: #fff;
    border: 2px solid #6c757d;
    z-index: 1;
    box-shadow: 0 0 0 2px #fff;
}

.marker-primary { border-color: #007bff; }
.marker-secondary { border-color: #6c757d; }
.marker-success { border-color: #28a745; }
.marker-danger { border-color: #dc3545; }
.marker-warning { border-color: #ffc107; }
.marker-info { border-color: #17a2b8; }
.marker-light { border-color: #f8f9fa; }
.marker-dark { border-color: #343a40; }

.timeline-content {
    background: transparent;
}

.badge-lg {
    font-size: 0.9em;
    padding: 0.5em 0.75em;
}

.timeline-inverse .timeline-item {
    background: #fff;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.info-box {
    transition: transform 0.2s;
}

.info-box:hover {
    transform: translateY(-2px);
}

.password-strength .progress {
    height: 4px;
}

.modal-header {
    border-bottom: 1px solid #dee2e6;
}

.modal-footer {
    border-top: 1px solid #dee2e6;
}

.card-header {
    border-bottom: 1px solid rgba(0,0,0,.125);
}

.list-group-item {
    border: 1px solid rgba(0,0,0,.125);
}

.timeline {
    position: relative;
    margin: 0 0 30px 0;
    padding: 0;
    list-style: none;
}

.timeline:before {
    content: '';
    position: absolute;
    top: 0;
    bottom: 0;
    width: 4px;
    background: #dee2e6;
    left: 31px;
    margin: 0;
    border-radius: 2px;
}
    </style>

.w-85 {
    width: 85% !important;
}
{% endblock scripts %}

<script>
// Password Security Indicator Functions
function evaluatePasswordSecurity() {
    // Password security evaluation simulation
    // In real implementation, this would analyze the actual password
    const features = {
        length: true,
        uppercase: true,
        lowercase: true,
        numbers: true,
        special: false
    };
    
    const score = Object.values(features).filter(Boolean).length;
    updateSecurityIndicator(score, features);
    checkPasswordAge();
}

function updateSecurityIndicator(score, features) {
    const badge = document.getElementById('securityBadge');
    const progressBar = document.getElementById('securityProgressBar');
    const recommendations = document.getElementById('securityRecommendations');
    
    // Update badge and progress bar based on score
    badge.className = 'security-level-badge';
    progressBar.className = 'security-progress-bar';
    
    if (score >= 4) {
        badge.classList.add('security-strong');
        progressBar.classList.add('security-progress-strong');
        badge.innerHTML = '<i class="fas fa-shield-alt"></i> Strong';
        recommendations.style.display = 'none';
    } else if (score >= 3) {
        badge.classList.add('security-good');
        progressBar.classList.add('security-progress-good');
        badge.innerHTML = '<i class="fas fa-shield-check"></i> Good';
        recommendations.style.display = 'block';
    } else if (score >= 2) {
        badge.classList.add('security-medium');
        progressBar.classList.add('security-progress-medium');
        badge.innerHTML = '<i class="fas fa-shield-virus"></i> Medium';
        recommendations.style.display = 'block';
    } else {
        badge.classList.add('security-weak');
        progressBar.classList.add('security-progress-weak');
        badge.innerHTML = '<i class="fas fa-shield-virus"></i> Weak';
        recommendations.style.display = 'block';
    }
}

function checkPasswordAge() {
    const lastChanged = document.getElementById('lastPasswordChange').textContent;
    const warning = document.getElementById('passwordAgeWarning');
    
    // Password age check simulation
    // In real implementation, this would calculate from last changed date
    if (lastChanged === 'Never' || isPasswordOld(lastChanged)) {
        warning.style.display = 'inline-block';
    } else {
        warning.style.display = 'none';
    }
}

function isPasswordOld(dateString) {
    // Check if password is old (>90 days) simulation
    // In real implementation, this would calculate date difference
    return false; // For demo, assume password is still new
}

// Initialize security indicator when page loads
document.addEventListener('DOMContentLoaded', function() {
    evaluatePasswordSecurity();
});

// Update security indicator when password is changed
function onPasswordChanged() {
    setTimeout(() => {
        evaluatePasswordSecurity();
        document.getElementById('lastPasswordChange').textContent = new Date().toLocaleDateString('en-US');
    }, 500);
}
</script>
