{% extends "base.html" %}

{% block title %}Retrain Model - Waskita{% endblock %}

{% block page_title %}
    Retrain Model
{% endblock page_title %}

{% block breadcrumb %}
    <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Home</a></li>
    <li class="breadcrumb-item">Admin Panel</li>
    <li class="breadcrumb-item active">Retrain Model</li>
{% endblock breadcrumb %}

{% block extra_css %}
<style>
    /* Dark Mode Enhancements for Retrain Model Page */
    body.dark-mode .custom-file-label {
        background-color: var(--input-bg);
        color: var(--input-color);
        border-color: var(--input-border);
    }

    body.dark-mode .custom-file-label::after {
        background-color: var(--body-bg);
        color: var(--white);
    }

    body.dark-mode .table-bordered {
        border-color: var(--table-border-color);
    }

    body.dark-mode .table-bordered th,
    body.dark-mode .table-bordered td {
        border-color: var(--table-border-color);
    }

    body.dark-mode .thead-light th {
        background-color: #343a40;
        color: var(--white);
        border-color: var(--table-border-color);
    }

    body.dark-mode .alert-light {
        background-color: #343a40;
        color: var(--white);
        border-color: var(--border-color);
    }

    body.dark-mode .text-muted {
        color: #adb5bd !important;
    }

    /* Loading Overlay Dark Mode */
    body.dark-mode .overlay.dark {
        background-color: rgba(0, 0, 0, 0.85);
        color: #ffffff;
    }

    /* Standardized Font Sizes */
    .card-title { font-size: 1.1rem !important; font-weight: 600; }
    
    /* Button Consistency */
    .btn { 
        padding: 6px 12px !important;
        font-size: 12px !important; 
        font-weight: 500;
        border-radius: 4px !important;
    }
    
    .alert h5 { font-size: 1rem !important; font-weight: 600; }
    .alert p { font-size: 0.9rem !important; }
    .table th { font-size: 0.9rem !important; font-weight: 600; text-transform: uppercase; }
    .table td { font-size: 0.9rem !important; }
    .form-group label { font-size: 0.95rem !important; font-weight: 500; }
</style>
{% endblock extra_css %}
{% block content %}
    <div class="row">
        <!-- Main Form -->
        <div class="col-12">
            <div class="card card-outline card-primary">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-sync-alt mr-1"></i> Retraining Form
                    </h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-tool" data-card-widget="collapse">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
                
                <div class="card-body">
                    
                    {% if results %}
                    <!-- Results Section -->
                    {% if temp_mode %}
                        <div class="alert alert-info">
                            <h5><i class="icon fas fa-info-circle"></i> Review Training Results</h5>
                            <p>New model has been trained. Please review the results below before deploying to production.</p>
                        </div>
                    {% else %}
                        <div class="alert alert-success">
                            <h5><i class="icon fas fa-check"></i> Success!</h5>
                            Classification model has been successfully updated to production.
                        </div>
                    {% endif %}
                    
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>Model</th>
                                    <th>Accuracy</th>
                                    <th>Precision</th>
                                    <th>Recall</th>
                                    <th>F1-Score</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for model_name, metrics in results.items() %}
                                <tr>
                                    <td>{{ model_name|replace('_', ' ')|title }}</td>
                                    <td>{{ "%.2f"|format(metrics.accuracy * 100) }}%</td>
                                    <td>{{ "%.2f"|format(metrics.precision * 100) }}%</td>
                                    <td>{{ "%.2f"|format(metrics.recall * 100) }}%</td>
                                    <td>{{ "%.2f"|format(metrics.f1 * 100) }}%</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-4 d-flex justify-content-between">
                        <a href="{{ url_for('admin.retrain_model') }}" class="btn btn-default">
                            <i class="fas fa-arrow-left mr-1"></i> Cancel / Retry
                        </a>
                        
                        {% if temp_mode %}
                        <form action="{{ url_for('admin.retrain_model') }}" method="post" class="d-inline">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="action" value="confirm_replace">
                            <button type="submit" class="btn btn-success" onclick="return confirm('Are you sure you want to replace the production model with this new model?');">
                                <i class="fas fa-save mr-1"></i> Save & Deploy Model
                            </button>
                        </form>
                        {% endif %}
                    </div>

                    {% elif mapping_mode %}
                    <div class="alert alert-success">
                        <i class="icon fas fa-check"></i> File uploaded successfully: <strong>{{ filename }}</strong>. Columns detected: <span class="badge badge-primary">{{ headers|length }}</span>
                    </div>
                    <div class="alert alert-info">
                        <i class="icon fas fa-info"></i> Please select the corresponding columns from the CSV file.
                    </div>

                    <form action="{{ url_for('admin.retrain_model') }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="action" value="train">
                        <input type="hidden" name="filename" value="{{ filename }}">
                        
                        <div class="form-group row">
                            <label for="col_text" class="col-sm-3 col-form-label">Text Column (Sentence)</label>
                            <div class="col-sm-9">
                                <select class="form-control" name="col_text" required>
                                    <option value="">-- Select Column --</option>
                                    {% for header in headers %}
                                    <option value="{{ header }}">{{ header }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group row">
                            <label for="col_label" class="col-sm-3 col-form-label">Label Column (Class)</label>
                            <div class="col-sm-9">
                                <select class="form-control" name="col_label" required>
                                    <option value="">-- Select Column --</option>
                                    {% for header in headers %}
                                    <option value="{{ header }}">{{ header }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="form-group mt-4">
                            <button type="submit" class="btn btn-primary float-right" id="btnTrainMap">
                                <i class="fas fa-play mr-1"></i> Start Training
                            </button>
                            <a href="{{ url_for('admin.retrain_model') }}" class="btn btn-default">Cancel</a>
                        </div>
                    </form>

                    {% else %}
                    <!-- Upload Form Section -->
                    <form id="retrainForm" action="{{ url_for('admin.retrain_model') }}" method="post" enctype="multipart/form-data">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        
                        <div class="alert alert-light border">
                            <h5><i class="icon fas fa-info-circle"></i> Info</h5>
                            <p class="mb-0">
                                Upload a new CSV dataset file to retrain the model. 
                                The new model will be temporarily stored for review before deployment.
                            </p>
                        </div>

                        <div class="form-group row mt-4">
                            <label for="datasetFile" class="col-sm-3 col-form-label">Dataset File (CSV)</label>
                            <div class="col-sm-9">
                                <div class="input-group">
                                    <div class="custom-file">
                                        <input type="file" class="custom-file-input" id="datasetFile" name="file" accept=".csv" required>
                                        <label class="custom-file-label" for="datasetFile">Choose file...</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4 d-flex justify-content-end">
                            <button type="submit" class="btn btn-primary" id="btnUpload">
                                <i class="fas fa-upload mr-1"></i> Upload & Continue
                            </button>
                        </div>
                        <div class="border-top mt-3 mb-3"></div>
                    </form>
                    {% if last_results %}
                    <div class="mt-5">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="m-0 text-muted"><i class="fas fa-history mr-1"></i> Retraining History</h5>
                        </div>
                        
                        <div id="historyAccordion">
                            {% for run in last_results %}
                            <div class="card card-outline card-secondary mb-3 shadow-sm">
                                <div class="card-header d-flex align-items-center bg-white">
                                    <h3 class="card-title flex-grow-1 m-0">
                                        <button class="btn btn-link btn-block text-left collapsed p-0 text-dark text-decoration-none" type="button" data-toggle="collapse" data-target="#collapse{{ run.id }}" aria-expanded="false" aria-controls="collapse{{ run.id }}">
                                            <i class="fas fa-calendar-alt mr-2 text-muted"></i> 
                                            <span class="font-weight-bold">{{ run.date }}</span>
                                            <span class="badge badge-info ml-3 px-2 py-1">{{ run.filename }}</span>
                                        </button>
                                    </h3>
                                    <div class="card-tools ml-auto d-flex align-items-center">
                                        <a href="{{ url_for('admin.export_training_run', run_id=run.id) }}" class="btn btn-tool text-secondary mr-2" title="Export CSV">
                                            <i class="fas fa-file-csv mr-1"></i> Export
                                        </a>
                                        <button type="button" class="btn btn-tool text-danger mr-2" onclick="confirmDelete('{{ url_for('admin.delete_training_run', run_id=run.id) }}')" title="Delete History">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        <button type="button" class="btn btn-tool" data-toggle="collapse" data-target="#collapse{{ run.id }}">
                                            <i class="fas fa-chevron-down"></i>
                                        </button>
                                    </div>
                                </div>
                                <div id="collapse{{ run.id }}" class="collapse" aria-labelledby="heading{{ run.id }}" data-parent="#historyAccordion">
                                    <div class="card-body p-0">
                                        <div class="table-responsive">
                                            <table class="table table-hover mb-0 align-middle">
                                                <thead class="bg-light">
                                                    <tr>
                                                        <th class="pl-4 py-3 text-uppercase text-secondary text-xs font-weight-bolder" style="width: 25%;">Model</th>
                                                        <th class="py-3 text-uppercase text-secondary text-xs font-weight-bolder">Accuracy</th>
                                                        <th class="py-3 text-uppercase text-secondary text-xs font-weight-bolder">Precision</th>
                                                        <th class="py-3 text-uppercase text-secondary text-xs font-weight-bolder">Recall</th>
                                                        <th class="py-3 text-uppercase text-secondary text-xs font-weight-bolder">F1-Score</th>
                                                        <th class="text-center py-3 text-uppercase text-secondary text-xs font-weight-bolder" style="width: 15%;">Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for model_name, metrics in run.metrics.items() %}
                                                    <tr>
                                                        <td class="pl-4 font-weight-bold text-dark">{{ model_name|replace('_', ' ')|title }}</td>
                                                        <td class="text-secondary">{{ "%.2f"|format(metrics.accuracy * 100) }}%</td>
                                                        <td class="text-secondary">{{ "%.2f"|format(metrics.precision * 100) }}%</td>
                                                        <td class="text-secondary">{{ "%.2f"|format(metrics.recall * 100) }}%</td>
                                                        <td class="text-secondary">{{ "%.2f"|format(metrics.f1 * 100) }}%</td>
                                                        <td class="text-center">
                                                            <button class="btn btn-sm btn-outline-primary px-3" onclick='showDetails("{{ model_name|replace('_', ' ')|title }}", {{ metrics|tojson }})'>
                                                                <i class="fas fa-chart-bar mr-1"></i> Visuals
                                                            </button>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    {% endif %}
                    
                </div>
                
                <!-- Details Modal -->
                <div class="modal fade" id="detailsModal" tabindex="-1" role="dialog" aria-labelledby="detailsModalLabel" aria-hidden="true" style="z-index: 10600 !important;">
                    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
                        <div class="modal-content">
                            <div class="modal-header bg-light">
                                <h5 class="modal-title" id="detailsModalLabel">Model Performance Details</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <ul class="nav nav-tabs mb-3" id="detailsTab" role="tablist">
                                    <li class="nav-item">
                                        <a class="nav-link active" id="metrics-tab" data-toggle="tab" href="#metrics" role="tab">Class Metrics</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="confusion-tab" data-toggle="tab" href="#confusion" role="tab">Confusion Matrix</a>
                                    </li>
                                </ul>
                                <div class="tab-content" id="detailsTabContent">
                                    <!-- Metrics Tab -->
                                    <div class="tab-pane fade show active" id="metrics" role="tabpanel">
                                        <canvas id="metricsChart" height="200"></canvas>
                                        <div class="table-responsive mt-3">
                                            <table class="table table-bordered table-sm" id="classMetricsTable">
                                                <thead class="thead-light">
                                                    <tr>
                                                        <th>Class</th>
                                                        <th>Precision</th>
                                                        <th>Recall</th>
                                                        <th>F1-Score</th>
                                                        <th>Support</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <!-- Populated by JS -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <!-- Confusion Matrix Tab -->
                                    <div class="tab-pane fade" id="confusion" role="tabpanel">
                                        <div class="d-flex justify-content-center">
                                            <div style="position: relative; height: 300px; width: 300px;">
                                                <canvas id="confusionMatrixChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loading Overlay -->
                <div class="overlay dark" id="loadingOverlay" style="display: none;">
                    <div class="text-center w-75">
                        <i class="fas fa-3x fa-sync-alt fa-spin mb-3"></i>
                        <h5 class="text-bold" id="loadingText">Processing...</h5>
                        <p id="loadingSubtext" class="mb-2">Please wait, this process may take a while.</p>
                        
                        <!-- Progress Bar -->
                        <div class="progress mt-3" style="height: 25px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                 role="progressbar" 
                                 style="width: 0%" 
                                 id="dynamicProgressBar"
                                 aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                0%
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}

{% block scripts %}
<script>
        $(document).ready(function () {
        if (typeof bsCustomFileInput !== 'undefined' && bsCustomFileInput && typeof bsCustomFileInput.init === 'function') {
            bsCustomFileInput.init();
        }

        // Update file label immediately when file selected
        $('#datasetFile').on('change', function() {
            var fileName = $(this).val().split('\\').pop();
            $(this).next('.custom-file-label').addClass("selected").html(fileName);
        });

        // Show loading overlay on form submit (Mapping or Upload)
        $('form').on('submit', function(e) {
            var form = $(this);
            var actionInput = form.find('input[name="action"]');
            
            // Check validity if standard validation is used
            if(this.checkValidity()) {
                var formId = form.attr('id');
                var action = actionInput.val();
                
                // --- SPECIAL HANDLING FOR TRAINING (ASYNC) ---
                if (action === 'train') {
                    e.preventDefault(); // Stop normal submit
                    
                    // 1. Serialize data BEFORE disabling inputs
                    var formData = form.serialize();
                    var csrfToken = form.find('input[name="csrf_token"]').val();
                    
                    // Force close any open dropdowns or inputs
                    $('select, input, button').blur();
                    // Disable all form inputs immediately
                    form.find('select, input, button').prop('disabled', true);
                    
                    var loadingText = "Training Model...";
                    var loadingSubtext = "Initializing training process...";
                    
                    $('#loadingText').text(loadingText);
                    $('#loadingSubtext').text(loadingSubtext);
                    
                    // Show overlay immediately and ensure it's on top
                    var overlay = $('#loadingOverlay');
                    overlay.css({
                        'display': 'flex',
                        'flex-direction': 'column',
                        'justify-content': 'center',
                        'align-items': 'center',
                        'z-index': '9999' // Ensure it covers everything
                    });
                    
                    var progressBar = $('#dynamicProgressBar');
                    progressBar.css('width', '0%').text('0%');
                    progressBar.removeClass('bg-danger').addClass('bg-primary');
                    
                    // 2. Start Training via AJAX using pre-serialized data
                    $.ajax({
                        url: form.attr('action') + (form.attr('action').includes('?') ? '&' : '?') + 'ajax=1',
                        type: 'POST',
                        data: formData,
                        headers: {
                            'X-CSRFToken': csrfToken,
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        success: function(response) {
                            if (response.task_id) {
                                // 2. Start Polling
                                startPolling(response.task_id);
                            } else {
                                showError("Unexpected response from server.");
                            }
                        },
                        error: function(xhr) {
                            var msg = "Training failed to start.";
                            if (xhr.responseJSON && xhr.responseJSON.error) {
                                msg = xhr.responseJSON.error;
                            }
                            showError(msg);
                        }
                    });
                    
                    return; // Exit handler
                }
                
                // --- STANDARD HANDLING FOR UPLOAD/CONFIRM ---
                var loadingText = "Processing...";
                var loadingSubtext = "Please wait...";
                var startProgress = 0;
                
                if(formId === 'retrainForm') {
                    // Upload phase
                    loadingText = "Uploading Dataset...";
                    loadingSubtext = "Reading and validating CSV file.";
                    startProgress = 10;
                } else if(action === 'confirm_replace') {
                    // Confirm phase
                    loadingText = "Deploying Model...";
                    loadingSubtext = "Saving model to production and reloading the system.";
                    startProgress = 50;
                }

                $('#loadingText').text(loadingText);
                $('#loadingSubtext').text(loadingSubtext);
                $('#loadingOverlay').css('display', 'flex').css('flex-direction', 'column').css('justify-content', 'center').css('align-items', 'center');
                
                // Simulate progress
                var progressBar = $('#dynamicProgressBar');
                var currentProgress = startProgress;
                progressBar.css('width', currentProgress + '%').text(currentProgress + '%');
                
                // Disable buttons to prevent double submit
                $(this).find('button[type="submit"]').prop('disabled', true);

                // Simulate progress bar movement
                var interval = setInterval(function() {
                    currentProgress += Math.floor(Math.random() * 5) + 1;
                    if(currentProgress > 90) {
                        currentProgress = 90; // Hold at 90 until complete
                        clearInterval(interval);
                    }
                    progressBar.css('width', currentProgress + '%').text(currentProgress + '%');
                }, 500);
            }
        });
        
        function startPolling(taskId) {
            var pollInterval = setInterval(function() {
                $.ajax({
                    url: '/admin/model/retrain/status/' + taskId,
                    type: 'GET',
                    success: function(data) {
                        // Update UI
                        var percent = data.progress || 0;
                        var message = data.message || "Processing...";
                        
                        $('#dynamicProgressBar').css('width', percent + '%').text(percent + '%');
                        $('#loadingSubtext').text(message);
                        
                        if (data.status === 'completed') {
                            clearInterval(pollInterval);
                            $('#loadingText').text("Finalizing...");
                            setTimeout(function() {
                                window.location.href = '/admin/model/retrain/finish/' + taskId;
                            }, 500);
                        } else if (data.status === 'error') {
                            clearInterval(pollInterval);
                            showError(data.error || "Unknown error occurred during training.");
                        }
                    },
                    error: function() {
                        // Don't stop polling on transient network errors immediately, but maybe count errors?
                        // For now, just log
                        console.log("Polling failed temporarily...");
                    }
                });
            }, 1000); // Poll every 1s
        }
        
        function showError(msg) {
            $('#loadingOverlay').hide();
            // Re-enable buttons and inputs
            $('form').find('select, input, button').prop('disabled', false);
            
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: msg
                });
            } else {
                alert("Error: " + msg);
            }
        }

        {% if mapping_mode and filename %}
        try {
            if (typeof swalSuccess === 'function') {
                swalSuccess('Upload Successful', 'File {{ filename }} uploaded successfully. Found {{ headers|length }} columns.');
            } else if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'success',
                    title: 'Upload Successful',
                    text: 'File {{ filename }} uploaded successfully. Found {{ headers|length }} columns.'
                });
            }
        } catch (e) {}
        {% endif %}
    });

    // Global chart instances
    var metricsChartInstance = null;

    $(document).ready(function() {
        // Date Filter Logic
        $('#historyDateFilter').on('change', function() {
            var date = $(this).val(); // YYYY-MM-DD
            filterHistory(date);
        });

        $('#clearDateFilter').on('click', function() {
            $('#historyDateFilter').val('');
            filterHistory('');
        });

        function filterHistory(dateStr) {
            $('#historyAccordion .card').each(function() {
                if (!dateStr) {
                    $(this).show();
                    return;
                }
                
                // Extract date from the card title (format YYYY-MM-DD HH:MM:SS)
                var itemDateFull = $(this).find('.card-header .font-weight-bold').text().trim();
                var itemDate = itemDateFull.split(' ')[0]; // Get YYYY-MM-DD
                
                if (itemDate === dateStr) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        }
    });

    function confirmDelete(url) {
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = url;
                }
            });
        } else {
            if (confirm("Are you sure you want to delete this history?")) {
                window.location.href = url;
            }
        }
    }

    function showDetails(modelName, metrics) {
        $('#detailsModalLabel').text('Performance Details: ' + modelName);
        $('#detailsModal').modal('show');
        
        // 1. Populate Metrics Table
        var tbody = $('#classMetricsTable tbody');
        tbody.empty();
        
        var classes = ['radikal', 'non-radikal'];
        var detailMetrics = metrics.detail_metrics || metrics.report;
        
        var chartLabels = [];
        var precisions = [];
        var recalls = [];
        var f1s = [];
        
        if (detailMetrics) {
            classes.forEach(function(cls) {
                if (detailMetrics[cls]) {
                    var m = detailMetrics[cls];
                    var row = '<tr>' +
                        '<td><span class="badge badge-' + (cls === 'radikal' ? 'danger' : 'success') + '">' + cls.toUpperCase() + '</span></td>' +
                        '<td>' + (m.precision * 100).toFixed(2) + '%</td>' +
                        '<td>' + (m.recall * 100).toFixed(2) + '%</td>' +
                        '<td>' + (m['f1-score'] * 100).toFixed(2) + '%</td>' +
                        '<td>' + m.support + '</td>' +
                    '</tr>';
                    tbody.append(row);
                    
                    chartLabels.push(cls.toUpperCase());
                    precisions.push(m.precision * 100);
                    recalls.push(m.recall * 100);
                    f1s.push(m['f1-score'] * 100);
                }
            });

            // Add Summary Rows (Accuracy, Macro Avg, Weighted Avg)
            var totalSupport = 0;
            if (detailMetrics['macro avg']) totalSupport = detailMetrics['macro avg'].support;
            else if (detailMetrics['weighted avg']) totalSupport = detailMetrics['weighted avg'].support;

            // Accuracy
            var accVal = metrics.accuracy;
            if (detailMetrics.accuracy !== undefined) accVal = detailMetrics.accuracy;
            
            if (accVal !== undefined) {
                 var row = '<tr style="border-top: 2px solid #dee2e6; background-color: #fcfcfc;">' +
                     '<td class="font-weight-bold">Accuracy</td>' +
                     '<td></td>' +
                     '<td></td>' +
                     '<td class="font-weight-bold">' + (accVal * 100).toFixed(2) + '%</td>' +
                     '<td class="font-weight-bold">' + (totalSupport || '') + '</td>' +
                 '</tr>';
                 tbody.append(row);
            }

            // Macro Avg
            if (detailMetrics['macro avg']) {
                var m = detailMetrics['macro avg'];
                var row = '<tr>' +
                    '<td class="font-weight-bold">Macro Avg</td>' +
                    '<td>' + (m.precision * 100).toFixed(2) + '%</td>' +
                    '<td>' + (m.recall * 100).toFixed(2) + '%</td>' +
                    '<td>' + (m['f1-score'] * 100).toFixed(2) + '%</td>' +
                    '<td>' + m.support + '</td>' +
                '</tr>';
                tbody.append(row);
            }

            // Weighted Avg
            if (detailMetrics['weighted avg']) {
                var m = detailMetrics['weighted avg'];
                var row = '<tr>' +
                    '<td class="font-weight-bold">Weighted Avg</td>' +
                    '<td>' + (m.precision * 100).toFixed(2) + '%</td>' +
                    '<td>' + (m.recall * 100).toFixed(2) + '%</td>' +
                    '<td>' + (m['f1-score'] * 100).toFixed(2) + '%</td>' +
                    '<td>' + m.support + '</td>' +
                '</tr>';
                tbody.append(row);
            }

        } else {
            tbody.append('<tr><td colspan="5" class="text-center">No detailed metrics available</td></tr>');
        }
        
        // 2. Render Metrics Chart
        var ctxMetrics = document.getElementById('metricsChart').getContext('2d');
        if (metricsChartInstance) {
            metricsChartInstance.destroy();
        }
        
        metricsChartInstance = new Chart(ctxMetrics, {
            type: 'bar',
            data: {
                labels: chartLabels,
                datasets: [
                    {
                        label: 'Precision',
                        data: precisions,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Recall',
                        data: recalls,
                        backgroundColor: 'rgba(255, 99, 132, 0.6)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'F1-Score',
                        data: f1s,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });
        
        // 3. Render Confusion Matrix Table
        var cm = metrics.confusion_matrix;
        // Reset container content first if needed or ensure canvas exists for next time? 
        // Actually since we replace html, we should reset it back to canvas if we want to support chart.js later.
        // But here we use Table permanently for this modal session.
        var cmContainer = $('#confusionMatrixChart').parent();
        
        if (cm && cm.length === 2) {
             // Find max value for coloring
             var maxVal = Math.max(cm[0][0], cm[0][1], cm[1][0], cm[1][1]);
             
             var getColor = function(val) {
                 var alpha = val / maxVal;
                 if (alpha < 0.1) alpha = 0.1; 
                 return 'rgba(0, 123, 255, ' + alpha + ')';
             };
             
             var html = '<table class="table table-bordered text-center h-100">' +
                 '<tr>' +
                     '<td class="align-middle bg-light font-weight-bold">True \\ Pred</td>' +
                     '<td class="align-middle font-weight-bold">Non-Radical</td>' +
                     '<td class="align-middle font-weight-bold">Radical</td>' +
                 '</tr>' +
                 '<tr>' +
                     '<td class="align-middle font-weight-bold">Non-Radical</td>' +
                     '<td class="align-middle text-dark" style="background-color: ' + getColor(cm[0][0]) + '">' + cm[0][0] + '<br><small>(TN)</small></td>' +
                     '<td class="align-middle text-dark" style="background-color: ' + getColor(cm[0][1]) + '">' + cm[0][1] + '<br><small>(FP)</small></td>' +
                 '</tr>' +
                 '<tr>' +
                     '<td class="align-middle font-weight-bold">Radical</td>' +
                     '<td class="align-middle text-dark" style="background-color: ' + getColor(cm[1][0]) + '">' + cm[1][0] + '<br><small>(FN)</small></td>' +
                     '<td class="align-middle text-dark" style="background-color: ' + getColor(cm[1][1]) + '">' + cm[1][1] + '<br><small>(TP)</small></td>' +
                 '</tr>' +
             '</table>';
             
             cmContainer.html(html);
        } else {
             cmContainer.html('<p class="text-center mt-5">Confusion Matrix not available</p>');
        }
    }
</script>
{% endblock %}
